# Диагностика ошибок API endpoint /auth/v1/admin/users

## Краткое описание проблемы
После выполнения устаревшей версии скрипта `fix-confirmation-token-nulls.sql` появились ошибки 500 при обращении к API endpoint `/auth/v1/admin/users` и падения `/token` при попытке логина (GoTrue не умеет приводить NULL → string).

## Анализ состояния данных

### Результаты выполнения скрипта fix-confirmation-token-nulls.sql:
- **Общее количество пользователей:** 51
- **Подтвержденные пользователи:** 50
- **Подтвержденные с NULL confirmation_token:** 50 ✅
- **Подтвержденные с пустым confirmation_token:** 0 ✅
- **Неподтвержденные пользователи:** 1

### Обнаруженные проблемы в данных:
1. **Один неподтвержденный пользователь** с email `import+c057b4c7-27bc-4b1c-ab4b-202dd9ecb722@fastlease.local` имеет:
   - `email_confirmed_at` = NULL
   - `confirmation_token` = '' (пустая строка)

## Анализ возможных причин ошибок 500

### 1. Проблема с десериализацией данных в API
**ВЕРДИКТ: Подтверждена 2025-11-14**

Скрипт установил `confirmation_token = NULL` для всех подтвержденных пользователей. Внутренний GoTrue (endpoint `/token` и `/auth/v1/admin/users`) сканирует колонку в строку и при NULL выбрасывает `sql: Scan error ... converting NULL to string is unsupported`, что приводит к 500.

### 2. Проблема с функцией get_auth_user_by_email()
**Вероятность: СРЕДНЯЯ**

Функция `get_auth_user_by_email` используется в коде для поиска пользователей по email. Изменения в данных могут повлиять на логику этой функции.

### 3. Нарушение бизнес-логики Supabase Auth
**Вероятность: НИЗКАЯ**

Скрипт мог нарушить внутренние бизнес-правила Supabase, связанные с обработкой токенов подтверждения.

## Предложения по исправлению

### Решение 1: Исправленный скрипт (Реализовано 2025-11-14)

- Миграция `20251114093000_restore_confirmation_token_defaults` и скрипт `scripts/fix-confirmation-token-nulls.sql` теперь приводят любые `NULL` в `auth.users.confirmation_token` к пустой строке `''` и выводят статистику.
- Из-за ограничений прав на `auth.users` автоматический rollback `NOT NULL`/`DEFAULT ''` невозможен — задача зафиксирована как manual follow-up для `supabase_auth_admin`.

### Решение 2: Восстановление данных
Использовать бэкап только в случае повторного запуска устаревшего скрипта.

### Решение 3: Исправление кода API
Не требуется: проблема возникает до нашего кода, в слое GoTrue.

## Следующие шаги

1. **Немедленно (выполнено 2025-11-14):** применить миграцию `20251114093000_restore_confirmation_token_defaults` (замена NULL → '') и обновленный `scripts/fix-confirmation-token-nulls.sql`.
2. **Краткосрочно:** прогнать smoke-тест логина (`POST /token`) и `/auth/v1/admin/users`.
3. **Долгосрочно:** добавить мониторинг, который алертит, если в `auth.users.confirmation_token` появляются NULL.

## Ход фикса 2025-11-14

1. Выявили 50 подтвержденных пользователей с `NULL confirmation_token` (см. раздел анализа) — любой логин падал.
2. Вручную обновили данные (`UPDATE auth.users SET confirmation_token = '' WHERE confirmation_token IS NULL`).
3. Задокументировали ограничение по привилегиям и зафиксировали необходимость вернуть `DEFAULT ''` + `NOT NULL`, когда появится доступ к роли `supabase_auth_admin`.
4. Обновили скрипт `scripts/fix-confirmation-token-nulls.sql`, чтобы он больше не переводил пустые строки в NULL.
