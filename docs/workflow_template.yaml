workflow:
  id: fast-lease-v1
  title: "Fast Lease — основной бизнес-процесс (Дубай)"
  entity: Deal
  owner_role: OP_MANAGER
  timezone: Asia/Dubai

roles:
  - code: ADMIN
    name: Администратор процесса
    categories: [auth, workflow]
  - code: OP_MANAGER
    name: Операционный менеджер
    categories: [auth, workflow]
  - code: SUPPORT
    name: Поддержка операций
    categories: [auth]
  - code: TECH_SPECIALIST
    name: Технический специалист
    categories: [auth, workflow]
  - code: FINANCE
    name: Финансовый отдел
    categories: [auth, workflow]
  - code: RISK_MANAGER
    name: Менеджер по управлению рисками
    categories: [workflow]
  - code: INVESTOR
    name: Инвестор / ЛПР
    categories: [auth, workflow]
  - code: LEGAL
    name: Юридический отдел
    categories: [workflow]
  - code: ACCOUNTING
    name: Бухгалтерия (опционально для пост-учёта)
    categories: [workflow]
  - code: CLIENT
    name: Покупатель
    categories: [auth]

kanban_order:
  - NEW
  - OFFER_PREP
  - FINANCE_REVIEW
  - INVESTOR_PENDING
  - CONTRACT_PREP
  - DOC_SIGNING
  - SIGNING_FUNDING
  - VEHICLE_DELIVERY
  - ACTIVE
  - CANCELLED

schemas:
  buyer_docs_company: &buyer_docs_company
    version: "1.0"
    save_to_buyer_profile: ["doc_company_license", "doc_emirates_id_manager", "doc_passport_manager", "doc_emirates_id_driver", "doc_passport_driver", "doc_driving_license", "doc_other"]
    fields:
      - id: doc_company_license
        type: file
        label: "Лицензия компании"
        document_type: company_license
      - id: doc_emirates_id_manager
        type: file
        label: "Emirates ID менеджера"
        document_type: doc_emirates_id_manager
      - id: doc_passport_manager
        type: file
        label: "Паспорт менеджера"
        document_type: doc_passport_manager
      - id: doc_emirates_id_driver
        type: file
        label: "Emirates ID водителя"
        document_type: doc_emirates_id_driver
      - id: doc_passport_driver
        type: file
        label: "Паспорт водителя"
        document_type: doc_passport_driver
      - id: doc_driving_license
        type: file
        label: "Водительские права (UAE)"
        document_type: doc_driving_license
      - id: doc_other
        type: file
        label: "Другой документ"
        document_type: other

  buyer_docs_individual: &buyer_docs_individual
    version: "1.0"
    save_to_buyer_profile: ["doc_passport_buyer", "doc_emirates_id_buyer", "doc_driving_license_buyer", "doc_second_driver_bundle", "doc_other"]
    fields:
      - id: doc_passport_buyer
        type: file
        label: "Паспорт покупателя"
        document_type: doc_passport_buyer
      - id: doc_emirates_id_buyer
        type: file
        label: "Emirates ID покупателя"
        document_type: doc_emirates_id_buyer
      - id: doc_driving_license_buyer
        type: file
        label: "Водительские права (UAE)"
        document_type: doc_driving_license_buyer
      - id: doc_second_driver_bundle
        type: file
        label: "Комплект документов второго водителя"
        document_type: doc_second_driver_bundle
      - id: doc_other
        type: file
        label: "Другой документ"
        document_type: other

  seller_docs_company: &seller_docs_company
    version: "1.0"
    save_to_seller_profile: ["doc_trade_license", "doc_company_license", "doc_trn", "doc_emirates_id_owner", "doc_other"]
    save_to_vehicle: ["doc_mulkia_certificate", "doc_passing_certificate", "doc_vehicle_possession_certificate", "doc_vcc_certificate", "doc_vehicle_transfer_certificate"]
    save_to_deal: ["doc_tax_invoice", "doc_hiyaza_certificate", "doc_noc_gps_letter", "doc_noc_company_letter"]
    fields:
      - id: doc_trade_license
        type: file
        label: "Торговая лицензия (Trade License)"
        document_type: trade_license
      - id: doc_company_license
        type: file
        label: "Лицензия компании"
        document_type: company_license
      - id: doc_trn
        type: file
        label: "TRN сертификат"
        document_type: trn_certificate
      - id: doc_emirates_id_owner
        type: file
        label: "Emirates ID владельца"
        document_type: emirates_id_owner
      - id: doc_mulkia_certificate
        type: file
        label: "Mulkia (Регистрация ТС)"
        document_type: mulkia_certificate
      - id: doc_passing_certificate
        type: file
        label: "Passing Certificate (Техосмотр)"
        document_type: passing_certificate
      - id: doc_hiyaza_certificate
        type: file
        label: "Hiyaza (Сертификат владения)"
        document_type: hiyaza_certificate
      - id: doc_tax_invoice
        type: file
        label: "Tax Invoice (Налоговый инвойс)"
        document_type: tax_invoice
      - id: doc_other
        type: file
        label: "Другой документ"
        document_type: other

  seller_docs_individual: &seller_docs_individual
    version: "1.0"
    save_to_seller_profile: ["doc_passport", "doc_emirates_id", "doc_other"]
    save_to_vehicle: ["doc_mulkia_certificate", "doc_passing_certificate", "doc_vehicle_possession_certificate", "doc_vcc_certificate", "doc_vehicle_transfer_certificate"]
    save_to_deal: ["doc_tax_invoice", "doc_hiyaza_certificate", "doc_noc_gps_letter", "doc_noc_company_letter"]
    fields:
      - id: doc_passport
        type: file
        label: "Паспорт"
        document_type: passport
      - id: doc_emirates_id
        type: file
        label: "Emirates ID"
        document_type: emirates_id
      - id: doc_mulkia_certificate
        type: file
        label: "Mulkia (Регистрация ТС)"
        document_type: mulkia_certificate
      - id: doc_passing_certificate
        type: file
        label: "Passing Certificate (Техосмотр)"
        document_type: passing_certificate
      - id: doc_hiyaza_certificate
        type: file
        label: "Hiyaza (Сертификат владения)"
        document_type: hiyaza_certificate
      - id: doc_tax_invoice
        type: file
        label: "Tax Invoice (Налоговый инвойс)"
        document_type: tax_invoice
      - id: doc_other
        type: file
        label: "Другой документ"
        document_type: other

  confirm_participants_v1: &confirm_participants_v1
    version: "1.1"
    fields:
      - id: section_buyer
        type: section_header
        label: "Покупатель"
      - id: client_id
        type: profile_selector
        label: "Покупатель"
        required: true
        readonly: true
        filter: "client"
      - id: client_info
        type: profile_viewer
        label: "Данные покупателя"
        depends_on: "client_id"
        source_field: "client_id"
      - id: doc_aecb_credit_report
        type: file
        label: "AECB Credit Report"
        document_type: aecb_credit_report

      - id: section_seller
        type: section_header
        label: "Продавец"
      - id: seller_id
        type: profile_selector
        label: "Продавец"
        required: true
        filter: "seller"
      - id: seller_vat_payer
        type: boolean
        label: "Продавец плательщик VAT"
      - id: seller_info
        type: profile_viewer
        label: "Данные продавца"
        depends_on: "seller_id"
        source_field: "seller_id"

      - id: section_broker
        type: section_header
        label: "Брокер"
      - id: broker_id
        type: profile_selector
        label: "Брокер (опционально)"
        required: false
        filter: "broker"
      - id: broker_info
        type: profile_viewer
        label: "Данные брокера"
        depends_on: "broker_id"
        source_field: "broker_id"
      - id: broker_commission
        type: currency
        label: "Комиссия брокера (AED)"
        required: false
        depends_on: "broker_id"
      - id: doc_broker_invoice
        type: file
        label: "Счет на оплату комиссии (Broker Invoice)"
        document_type: invoice
        required: false
        depends_on: "broker_id"

      - id: section_commissions
        type: section_header
        label: "Комиссии менеджеров"
      - id: renty_manager_commission
        type: text
        label: "Комиссия менеджера Fast Lease (%)"
        readonly: true
      - id: showroom_manager_fee
        type: currency
        label: "Комиссия менеджера салона (AED)"

  confirm_car_v3: &confirm_car_v3
    version: "1.0"
    fields:
      - id: section_vehicle
        type: section_header
        label: "Автомобиль и Документы"
      - id: vehicle_price
        type: currency
        label: "Стоимость авто (AED)"
        required: true
      - id: seller_vehicle_price_with_vat
        type: boolean
        label: "Авто продается с VAT"
      - id: insurance_amount
        type: currency
        label: "Стоимость авто от страховой (AED)"
      - id: registration_amount
        type: currency
        label: "Сумма регистрации (AED)"
      - id: technical_inspection_amount
        type: currency
        label: "Сумма за технический осмотр авто (AED)"
      - id: doc_technical_report
        type: file
        label: "Технический отчёт"
        document_type: technical_report
        required: true
      - id: analog_market_url_1
        type: text
        label: "Аналоги на площадках #1"
      - id: analog_market_pdf_1
        type: file
        label: "PDF Страница #1"
        document_type: other
        required: false
      - id: analog_market_url_2
        type: text
        label: "Аналоги на площадках #2"
      - id: analog_market_pdf_2
        type: file
        label: "PDF Страница #2"
        document_type: other
        required: false
      - id: analog_market_url_3
        type: text
        label: "Аналоги на площадках #3"
      - id: analog_market_pdf_3
        type: file
        label: "PDF Страница #3"
        document_type: other
        required: false
      - id: analog_market_plus1_url_1
        type: text
        label: "Аналоги на площадках +1 год #1"
      - id: analog_market_plus1_pdf_1
        type: file
        label: "PDF Страница +1 год #1"
        document_type: other
        required: false
      - id: analog_market_plus1_url_2
        type: text
        label: "Аналоги на площадках +1 год #2"
      - id: analog_market_plus1_pdf_2
        type: file
        label: "PDF Страница +1 год #2"
        document_type: other
        required: false
      - id: analog_market_plus1_url_3
        type: text
        label: "Аналоги на площадках +1 год #3"
      - id: analog_market_plus1_pdf_3
        type: file
        label: "PDF Страница +1 год #3"
        document_type: other
        required: false

document_types:
  deal:
    registry:
      - value: noc_gps_letter
        label: "NOC letter от GPS"
        context: deal
      - value: vcc_certificate
        label: "VCC (Vehicle Certificate of Conformity)"
        context: deal
      - value: vehicle_possession_certificate
        label: "Vehicle Possession Certificate"
        context: deal
      - value: hiyaza_certificate
        label: "Hiyaza"
        context: deal
      - value: mulkia_certificate
        label: "Mulkia"
        context: deal
      - value: passing_certificate
        label: "Passing Certificate"
        context: deal
      - value: rental_contract
        label: "Договор долгосрочной аренды"
        context: deal
      - value: lease_agreement
        label: "Договор лизинга"
        context: deal
      - value: signed_lease_agreement
        label: "Подписанный договор лизинга"
        context: deal
      - value: purchase_agreement
        label: "Договор купли-продажи"
        context: deal
      - value: signed_purchase_agreement
        label: "Подписанный договор купли-продажи"
        context: deal
      - value: preliminary_purchase_agreement
        label: "Предварительный договор купли-продажи"
        context: deal
      - value: authorization_letter
        label: "Authorization Letter"
        context: deal
      - value: payment_schedule
        label: "График платежей"
        context: deal
      - value: signed_payment_schedule
        label: "Подписанный график платежей"
        context: deal
      - value: tax_invoice
        label: "Tax Invoice"
        context: deal
      - value: invoice
        label: "Invoice (без VAT)"
        context: deal
      - value: delivery_act
        label: "Акт приема-передачи"
        context: deal
      - value: signed_delivery_act
        label: "Подписанный акт приема-передачи"
        context: deal
      - value: technical_report
        label: "Технический отчёт"
        context: deal
      - value: commercial_offer
        label: "Коммерческое предложение"
        context: deal
      - value: signed_commercial_offer
        label: "Коммерческое предложение (подписанное)"
        context: deal
      - value: quotation
        label: "Quotation"
        context: deal
      - value: payment_receipt
        label: "Подтверждение оплаты"
        context: deal
      - value: spa_invoice
        label: "SPA Invoice"
        context: deal
      - value: noc_company_letter
        label: "NOC letter от компании"
        context: deal
      - value: vehicle_inspection_certificate
        label: "Сертификат техосмотра"
        context: deal
      - value: vehicle_transfer_certificate
        label: "Сертификат передачи транспортного средства"
        context: deal
      - value: certificate_of_installation
        label: "Сертификат установки (GPS)"
        context: deal
      - value: delivery_form
        label: "Акт приёма-передачи"
        context: deal
      - value: insurance_policy
        label: "Страховой полис"
        context: deal
      - value: insurance_policy_with_tax_invoice
        label: "Страховка с налоговым инвойсом"
        context: deal

  client:
    registry:
      - value: doc_emirates_id_manager
        label: "Emirates ID менеджера лицензии"
        context: company
      - value: doc_passport_manager
        label: "Паспорт менеджера лицензии"
        context: company
      - value: doc_emirates_id_driver
        label: "Emirates ID водителя"
        context: company
      - value: doc_passport_driver
        label: "Паспорт водителя"
        context: company
      - value: identity_document
        label: "Документ, удостоверяющий личность"
        context: personal
      - value: salary_certificate
        label: "Справка о доходах"
        context: personal
      - value: bank_statement
        label: "Банковская выписка"
        context: personal
      - value: proof_of_address
        label: "Подтверждение адреса"
        context: personal
      - value: company_license
        label: "Лицензия компании"
        context: company
      - value: corporate_documents
        label: "Корпоративные документы"
        context: company
      - value: company_bank_statement
        label: "Банковская выписка компании"
        context: company
      - value: aecb_credit_report
        label: "AECB Credit Report"
        context: any
      - value: trn_certificate
        label: "TRN-сертификат"
        context: any
      - value: other
        label: "Другой документ"
        context: any
      - value: doc_passport_buyer
        label: "Паспорт покупателя"
        context: personal
      - value: doc_emirates_id_buyer
        label: "Emirates ID покупателя"
        context: personal
      - value: doc_driving_license_buyer
        label: "Водительские права (UAE) покупателя"
        context: personal
      - value: doc_second_driver_bundle
        label: "Комплект документов второго водителя"
        context: personal
      - value: doc_emirates_id_owner
        label: "Emirates ID владельца"
        context: company
      - value: doc_emirates_id_seller
        label: "Emirates ID продавца"
        context: personal
      - value: doc_driving_license
        label: "Водительские права (UAE) покупателя/водителя"
        context: company

  seller:
    registry:
      - value: trade_license
        label: "Торговая лицензия (Trade License)"
        context: company
      - value: company_license
        label: "Лицензия компании"
        context: company
      - value: trn_certificate
        label: "TRN сертификат"
        context: company
      - value: emirates_id_owner
        label: "Emirates ID владельца"
        context: company
      - value: mulkia_certificate
        label: "Mulkia"
        context: any
      - value: hiyaza_certificate
        label: "Hiyaza"
        context: any
      - value: passing_certificate
        label: "Сертификат прохождения (Passing)"
        context: any
      - value: tax_invoice
        label: "Налоговый инвойс"
        context: any
      - value: passport
        label: "Паспорт"
        context: personal
      - value: emirates_id
        label: "Emirates ID"
        context: personal
      - value: other
        label: "Другой документ"
        context: any

  vehicle:
    registry:
      - value: vehicle_registration
        label: "Регистрационные данные транспортного средства"
        context: vehicle
      - value: other
        label: "Другой документ"
        context: vehicle


statuses:
  NEW:
    title: "Новая заявка"
    entry_actions:
      - type: TASK_CREATE
        task:
          template_id: prepare_quote_v1
          type: PREPARE_QUOTE
          title: "Подписание покупателем коммерческого предложения"
          assignee_role: OP_MANAGER
          guard_key: "quotationPrepared"
          sla: { hours: 8 }
          schema:
            version: "1.0"
            fields:
              - id: instructions
                type: textarea
                label: "Инструкции"
              - id: doc_signed_commercial_offer
                type: file
                label: "Коммерческое предложение (подписанное)"
                required: true
                document_type: signed_commercial_offer
          defaults:
            instruction_short: "Загрузите подписанное КП покупателя через задачу. Сам документ формируйте в карточке сделки."
            doc_signed_commercial_offer: ""
          bindings:
            deal_id: "{{deal.id}}"
      - type: NOTIFY
        to_roles: [OP_MANAGER]
        template: "new_deal_created"
    exit_requirements:
      - key: quotationPrepared
        rule: "== true"
        message: "Нет подписанного КП."

  OFFER_PREP:
    title: "Подтверждение авто и участников"
    entry_actions:
      - type: TASK_CREATE
        task:
          template_id: confirm_car_v3
          type: CONFIRM_CAR
          title: "Подтверждение авто"
          assignee_role: OP_MANAGER
          guard_key: "tasks.confirmCar.completed"
          sla: { hours: 1 }
          schema: *confirm_car_v3
          defaults:
            instruction_short: "Подтвердите стоимость авто и доп. расходы."
            registration_amount: "2500"
            technical_inspection_amount: "1000"
            seller_vehicle_price_with_vat: false
            doc_technical_report: ""
          bindings:
            deal_id: "{{deal.id}}"
            current_status: "{{deal.status}}"
      - type: TASK_CREATE
        task:
          template_id: confirm_participants_v1
          type: CONFIRM_PARTICIPANTS
          title: "Подтверждение участников сделки"
          assignee_role: OP_MANAGER
          guard_key: "tasks.confirmParticipants.completed"
          sla: { hours: 1 }
          schema: *confirm_participants_v1
          defaults:
            instruction_short: "Выберите продавца и брокера (если есть)."
            broker_commission: "0"
            seller_vat_payer: false
          bindings:
            deal_id: "{{deal.id}}"
    exit_requirements:
      - key: tasks.confirmCar.completed
        rule: "== true"
        message: "Данные об авто не подтверждены."
      - key: tasks.confirmParticipants.completed
        rule: "== true"
        message: "Участники сделки не подтверждены."

  FINANCE_REVIEW:
    title: "Финансовое утверждение"
    entry_actions:
      - type: TASK_CREATE
        task:
          defaults:
            instruction_short: "Проверьте финансовую модель сделки и утвердите или верните."
          template_id: finance_review_v1
          type: FIN_CALC
          title: "Проверка и утверждение финансовой структуры сделки"
          assignee_role: FINANCE
          guard_key: "finance.approved"
          sla: { hours: 48 }
          schema:
            version: "1.0"
            fields:
              - id: deal_id
                type: badge
                label: "ID сделки"
          bindings:
            deal_id: "{{deal.id}}"
    exit_requirements:
      - key: finance.approved
        rule: "== true"
        message: "Финансовые параметры не утверждены."

  INVESTOR_PENDING:
    title: "Одобрение инвестора"
    entry_actions:
      - type: TASK_CREATE
        task:
          defaults:
            instruction_short: "Проверьте финансовую модель сделки и утвердите или верните."
          template_id: investor_approval_v1
          type: INVESTOR_APPROVAL
          title: "Согласование сделки инвестором"
          assignee_role: INVESTOR
          guard_key: "investor.approved"
          sla: { hours: 48 }
          schema:
            version: "1.0"
            fields:
              - id: deal_id
                type: badge
                label: "ID сделки"
          bindings:
            deal_id: "{{deal.id}}"
      - type: NOTIFY
        to_roles: [INVESTOR]
        template: "need_investor_approval"
    exit_requirements:
      - key: investor.approved
        rule: "== true"
        message: "Нет подтверждения инвестора."

  CONTRACT_PREP:
    title: "Подготовка договора"
    entry_actions:
      - type: TASK_CREATE
        task:
          template_id: prepare_contract_v1
          type: PREPARE_CONTRACT
          title: "Сформировать договор/график платежей/акт приема-передачи"
          assignee_role: LEGAL
          guard_key: "legal.contractReady"
          sla: { hours: 24 }
          schema:
            version: "1.0"
            fields:
              - id: doc_purchase_agreement
                type: file
                label: "Договор купли-продажи"
                document_type: purchase_agreement
                required: true
              - id: doc_preliminary_purchase_agreement
                type: file
                label: "Предварительный договор купли-продажи"
                document_type: preliminary_purchase_agreement
                required: true
              - id: doc_lease_agreement
                type: file
                label: "Договор лизинга"
                document_type: lease_agreement
                required: true
              - id: doc_payment_schedule
                type: file
                label: "График платежей"
                document_type: payment_schedule
                required: true
              - id: doc_delivery_act
                type: file
                label: "Акт приема-передачи"
                document_type: delivery_act
                required: true
              - id: doc_authorization_letter
                type: file
                label: "Authorization Letter"
                document_type: authorization_letter
                required: false
          defaults:
            doc_preliminary_purchase_agreement: ""
            doc_authorization_letter: ""
            instruction_short: "Сформируйте договор и материалы для подписания."
    exit_requirements:
      - key: legal.contractReady
        rule: "== true"
        message: "Договор ещё не готов."

  DOC_SIGNING:
    title: "Подписание документов"
    entry_actions:
      - type: TASK_CREATE
        task:
          template_id: doc_signing_v1
          type: DOC_SIGNING
          title: "Подписание документов"
          assignee_role: OP_MANAGER
          guard_key: "contracts.signedUploaded"
          sla: { hours: 24 }
          schema:
            version: "1.0"
            fields:
              - id: signed_purchase_agreement
                type: file
                label: "Подписанный договор купли-продажи"
                document_type: signed_purchase_agreement
                required: true
              - id: signed_preliminary_purchase_agreement
                type: file
                label: "Подписанный предварительный договор купли-продажи"
                document_type: signed_preliminary_purchase_agreement
                required: true
              - id: signed_lease_agreement
                type: file
                label: "Подписанный договор лизинга"
                document_type: signed_lease_agreement
                required: true
              - id: signed_payment_schedule
                type: file
                label: "Подписанный график платежей"
                document_type: signed_payment_schedule
                required: true
              - id: signed_delivery_act
                type: file
                label: "Подписанный акт приема-передачи"
                document_type: signed_delivery_act
                required: true
              - id: doc_authorization_letter
                type: file
                label: "Authorization Letter"
                document_type: authorization_letter
                required: false
              - id: doc_tax_invoice
                type: file
                label: "Tax Invoice (для VAT-продавцов)"
                document_type: tax_invoice
                required: false
              - id: doc_invoice
                type: file
                label: "Invoice (без VAT)"
                document_type: invoice
                required: false
              - id: doc_receipt_voucher
                type: file
                label: "Receipt voucher (от продавца)"
                document_type: payment_receipt
                required: false
              - id: doc_payment_order
                type: file
                label: "Платежное поручение"
                document_type: payment_receipt
                required: false
          defaults:
            instruction_short: "Приложите подписанные документы сделки."
            doc_authorization_letter: ""
            doc_tax_invoice: ""
            doc_invoice: ""
            doc_receipt_voucher: ""
            doc_payment_order: ""
    exit_requirements:
      - key: contracts.signedUploaded
        rule: "== true"
        message: "Нет подписанных документов."

  SIGNING_FUNDING:
    title: "Подписание и финансирование"
    entry_actions:
      - type: WEBHOOK
        endpoint: "esign.createEnvelope"
        payload:
          dealId: "{{deal.id}}"
          parties:
            customer: "{{customer.email}}"
            investor: "{{investor.email}}"
      - type: TASK_CREATE
        task:
          template_id: receive_advance_v1
          type: RECEIVE_ADVANCE
          title: "Создание инвойса на оплату первого взноса клиенту"
          assignee_role: FINANCE
          guard_key: "payments.advanceReceived"
          sla: { hours: 24 }
          schema:
            version: "1.0"
            fields:
              - id: tax_invoice
                type: file
                label: "Инвойс на первый взнос"
                document_type: tax_invoice
                required: true
          defaults:
            instruction_short: "Проверьте получение первого взноса и приложите подтверждение (инвойс)."
      - type: TASK_CREATE
        task:
          template_id: pay_supplier_v1
          type: PAY_SUPPLIER
          title: "Оплата поставщику (дилеру)"
          assignee_role: FINANCE
          guard_key: "payments.supplierPaid"
          sla: { hours: 12 }
          schema:
            version: "1.0"
            fields:
              - id: quotation
                type: file
                label: "Quotation"
                document_type: quotation
                required: false
              - id: payment_receipt
                type: file
                label: "Подтверждение оплаты"
                document_type: payment_receipt
                required: true
          defaults:
            instruction_short: "Проверьте данные и приложите платёжку поставщику."
    exit_requirements:
      - key: payments.advanceReceived
        rule: "== true"
        message: "Аванс не получен."
      - key: payments.supplierPaid
        rule: "== true"
        message: "Оплата поставщику не проведена."

  VEHICLE_DELIVERY:
    title: "Выдача автомобиля"
    entry_actions:
      - type: TASK_CREATE
        task:
          defaults:
            instruction_short: "Приложите контракт аренды, страховой полис, GPS сертификат и Mulkia, подтвердите готовность."
            registration_salik: false
            registration_darb: false
          template_id: arrange_delivery_v1
          type: ARRANGE_DELIVERY
          title: "Организовать выдачу авто покупателю"
          assignee_role: TECH_SPECIALIST
          guard_key: "delivery.confirmed"
          sla: { hours: 24 }
          schema:
            version: "1.0"
            fields:
              - id: doc_rental_contract
                type: file
                label: "Договор долгосрочной аренды"
                document_type: rental_contract
                required: true
              - id: doc_insurance_policy
                type: file
                label: "Страховой полис"
                document_type: insurance_policy
                required: true
              - id: doc_gps_certificate
                type: file
                label: "Сертификат установки (GPS)"
                document_type: certificate_of_installation
                required: true
              - id: doc_mulkia_certificate
                type: file
                label: "Mulkia"
                document_type: mulkia_certificate
                required: true
              - id: registration_salik
                type: boolean
                label: "Регистрация Salik"
              - id: registration_darb
                type: boolean
                label: "Регистрация Darb"
    exit_requirements:
      - key: delivery.confirmed
        rule: "== true"
        message: "Выдача авто не подтверждена."

  ACTIVE:
    title: "Активный лизинг"
    entry_actions:
      - type: SCHEDULE
        job:
          type: "INVOICE_SCHEDULE"
          cron: "0 8 1 * *"   # инвойс ежемесячно 1-го числа 08:00
      - type: NOTIFY
        to_roles: [OP_MANAGER, ACCOUNTING]
        template: "lease_activated"
    exit_requirements: []  # финальный статус

  CANCELLED:
    title: "Отменена"
    entry_actions:
      - type: NOTIFY
        to_roles: [OP_MANAGER]
        template: "deal_cancelled"
    exit_requirements: []  # терминальное состояние

transitions:
  - from: NEW
    to: OFFER_PREP
    by_roles: [OP_MANAGER]
    guards:
      - key: quotationPrepared
        rule: "== true"

  - from: OFFER_PREP
    to: FINANCE_REVIEW
    by_roles: [OP_MANAGER]
    guards:
      - key: tasks.confirmParticipants.completed
        rule: "== true"
      - key: tasks.confirmCar.completed
        rule: "== true"

  - from: FINANCE_REVIEW
    to: INVESTOR_PENDING
    by_roles: [OP_MANAGER, FINANCE]
    guards:
      - key: finance.approved
        rule: "== true"

  - from: INVESTOR_PENDING
    to: CONTRACT_PREP
    by_roles: [OP_MANAGER, INVESTOR]
    guards:
      - key: investor.approved
        rule: "== true"

  - from: CONTRACT_PREP
    to: DOC_SIGNING
    by_roles: [OP_MANAGER, LEGAL]
    guards:
      - key: legal.contractReady
        rule: "== true"

  - from: DOC_SIGNING
    to: SIGNING_FUNDING
    by_roles: [OP_MANAGER]
    guards:
      - key: contracts.signedUploaded
        rule: "== true"

  - from: SIGNING_FUNDING
    to: VEHICLE_DELIVERY
    by_roles: [OP_MANAGER, TECH_SPECIALIST]
    guards:
      - key: payments.advanceReceived
        rule: "== true"
      - key: payments.supplierPaid
        rule: "== true"

  - from: VEHICLE_DELIVERY
    to: ACTIVE
    by_roles: [OP_MANAGER, TECH_SPECIALIST]
    guards:
      - key: delivery.confirmed
        rule: "== true"

  # Отмена сделки на любом этапе по решению операционного менеджера
  - from: NEW
    to: CANCELLED
    by_roles: [OP_MANAGER]
  - from: OFFER_PREP
    to: CANCELLED
    by_roles: [OP_MANAGER]

  - from: FINANCE_REVIEW
    to: CANCELLED
    by_roles: [OP_MANAGER]
  - from: INVESTOR_PENDING
    to: CANCELLED
    by_roles: [OP_MANAGER]
  - from: CONTRACT_PREP
    to: CANCELLED
    by_roles: [OP_MANAGER]
  - from: DOC_SIGNING
    to: CANCELLED
    by_roles: [OP_MANAGER]
  - from: SIGNING_FUNDING
    to: CANCELLED
    by_roles: [OP_MANAGER]
  - from: VEHICLE_DELIVERY
    to: CANCELLED
    by_roles: [OP_MANAGER, TECH_SPECIALIST]

permissions:
  # Пример матрицы доступа: кто может менять что
  DEAL_VIEW:
    roles: [OP_MANAGER, TECH_SPECIALIST, RISK_MANAGER, FINANCE, INVESTOR, LEGAL, ACCOUNTING, ADMIN]
  DEAL_EDIT:
    roles: [OP_MANAGER, ADMIN]
  STATUS_TRANSITION:
    rules:
      - role: OP_MANAGER
        allowed_from: [NEW, OFFER_PREP, FINANCE_REVIEW, INVESTOR_PENDING, CONTRACT_PREP, DOC_SIGNING, SIGNING_FUNDING, VEHICLE_DELIVERY]
      - role: TECH_SPECIALIST
        allowed_from: [VEHICLE_DELIVERY]

      - role: FINANCE
        allowed_from: [FINANCE_REVIEW, SIGNING_FUNDING]
      - role: INVESTOR
        allowed_from: [INVESTOR_PENDING]
      - role: LEGAL
        allowed_from: [CONTRACT_PREP]

integrations:
  webhooks:
    aecb.request: "https://{{host}}/api/int/aecb/request"
    esign.createEnvelope: "https://{{host}}/api/int/esign/create"
  callbacks:
    esign.completed: "POST https://{{host}}/api/webhooks/esign"
    bank.paymentConfirmed: "POST https://{{host}}/api/webhooks/bank"
  retries:
    policy: exponential
    base_ms: 500
    max_retries: 5

metrics:
  enabled: true
  timers:

    - name: "t_fin_approval"
      from: FINANCE_REVIEW
      to: INVESTOR_PENDING
    - name: "t_total_to_active"
      from: NEW
      to: ACTIVE
  export:
    prometheus: "/metrics/process"
    dimensions: [source, op_manager_id, investor_id]

notifications:
  channels:
    - email
    - whatsapp
    - telegram
  templates:
    new_deal_created: "Создана новая заявка #{{deal.id}}"
    sla_warning: "Задание по сделке #{{deal.id}} близко к просрочке."
    sla_breach: "Просрочка SLA по сделке #{{deal.id}}."
    need_investor_approval: "Сделка #{{deal.id}} ожидает одобрения инвестора."
    lease_activated: "Лизинг активирован по сделке #{{deal.id}}."
