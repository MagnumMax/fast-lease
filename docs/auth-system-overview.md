# Обзор системы аутентификации Fast Lease

## Архитектура аутентификации

Система аутентификации построена на Supabase Auth с использованием ролевой модели доступа (RBAC).

### Основные компоненты

#### 1. Роли пользователей
```typescript
type AppRole =
  | "client"        // Клиент (базовая роль)
  | "investor"      // Инвестор
  | "operator"      // Оператор
  | "ops_manager"   // Операционный менеджер
  | "finance"       // Финансовый специалист
  | "support"       // Специалист поддержки
  | "admin"         // Администратор
```

#### 2. Иерархия ролей по приоритету
```
admin > ops_manager > operator > finance > support > investor > client
```

#### 3. Домашние пути по ролям
- `admin` → `/admin/bpm`
- `ops_manager` → `/ops/dashboard`
- `operator` → `/ops/dashboard`
- `finance` → `/ops/deals`
- `support` → `/ops/tasks`
- `investor` → `/investor/dashboard`
- `client` → `/client/dashboard`

## Процесс аутентификации

### Различия между средами

#### Development среда
- **Селектор ролей видим** для быстрого тестирования
- **Предустановленные email** для каждой роли:
  - `client@fastlease.io`
  - `investor@fastlease.io`
  - `ops.manager@fastlease.io`
  - `admin@fastlease.io`
- **Magic Link Bypass** - автоматическая аутентификация без реальных OTP

#### Production среда
- **Селектор ролей скрыт**
- **Реальные email/телефоны** пользователей
- **Настоящие OTP коды** через email/SMS

### Двухэтапный процесс

#### Этап 1: Запрос OTP (`requestOtpAction`)
1. Пользователь выбирает роль (DEV) или вводит email/телефон (PROD)
2. Система отправляет OTP код через Supabase Auth
3. Поддержка email и SMS каналов
4. В DEV среде возможен автоматический bypass

#### Этап 2: Верификация OTP (`verifyOtpAction`)
1. Пользователь вводит полученный код
2. Supabase проверяет корректность кода
3. Создается сессия пользователя
4. Назначаются роли в базе данных
5. Обновляется время последнего логина

## Защита роутов

### Middleware контроль доступа

#### Защищенные префиксы:
- `/client` - только для клиентов
- `/ops` - для операционных ролей (ops_manager, operator, finance, support)
- `/admin` - только для администраторов
- `/investor` - для инвесторов и администраторов

#### Логика middleware:
1. Проверяет наличие сессии пользователя
2. Загружает роли из базы данных
3. Контролирует доступ на основе правил ролей
4. Перенаправляет в соответствующий дашборд при нарушении прав

## Структура базы данных

### Таблицы:
- `profiles` - профили пользователей
- `user_roles` - роли пользователей (многие-ко-многим)
- Supabase Auth tables - сессии и аутентификация

### Поля профиля:
```typescript
interface ProfileRecord {
  id: string;
  user_id: string;
  status: string;
  full_name: string | null;
  phone: string | null;
  // ... другие поля
  last_login_at: string | null;
  created_at: string;
  updated_at: string;
}
```

## Безопасность

### Механизмы защиты:
1. **Row Level Security (RLS)** политики в Supabase
2. **Middleware контроль** доступа к роутам
3. **Маскировка данных** в интерфейсе (email/телефон)
4. **Автоматический logout** при истечении сессии

### Разделение ответственности:
- **Supabase Auth** - управление сессиями и OTP
- **Middleware** - контроль доступа к роутам
- **Компоненты** - UI и пользовательский опыт
- **Server Actions** - бизнес-логика аутентификации

## Разработка и тестирование

### Быстрое тестирование ролей:
1. Выбрать роль из селектора в DEV среде
2. Ввести соответствующий email
3. Система автоматически создаст сессию
4. Пользователь попадет в соответствующий дашборд

### Отладка:
- Проверить консоль браузера на ошибки аутентификации
- Изучить логи Supabase для проблем с OTP
- Тестировать разные роли для проверки прав доступа

## Расширение системы

### Добавление новой роли:
1. Добавить роль в `AppRole` тип
2. Добавить в `APP_ROLE_PRIORITY` массив
3. Определить домашний путь в `APP_ROLE_HOME_PATH`
4. Настроить правила доступа в `accessRules`
5. Создать соответствующий дашборд

Эта система обеспечивает надежную и гибкую аутентификацию с четким разделением прав доступа между разными типами пользователей платформы.