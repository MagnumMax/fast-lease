<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fast Lease — Новая заявка</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } } };</script>
  <link rel="stylesheet" href="../../assets/style.css" />
</head>
<body class="bg-slate-50 font-sans text-slate-900">
  <header class="border-b border-slate-200 bg-white/80 px-6 py-4 backdrop-blur">
    <div class="mx-auto flex w-full max-w-6xl items-center justify-between">
      <a href="../../client/dashboard/index.html" class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-slate-900 text-white font-semibold">FL</div>
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Fast Lease</p>
          <p class="text-base font-semibold text-slate-900">Новая заявка</p>
        </div>
      </a>
      
    </div>
  </header>

  <main class="mx-auto w-full max-w-6xl px-6 py-8">
    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Пошаговый процесс</p>
          <h1 class="mt-2 text-2xl font-semibold text-slate-900">Заполните и загрузите данные</h1>
          <p class="text-sm text-slate-500">Мы подскажем, если какой-то документ не пройдет проверку качества.</p>
        </div>
        <div class="text-sm text-slate-600">
          Прогресс: <span id="step-progress" class="font-semibold text-slate-900">1/3</span>
        </div>
      </div>

      <!-- Выбранная модель: бейдж -->
      <div id="selected-car-badge" class="mt-4"></div>

      <div class="mt-6 grid gap-6 lg:grid-cols-[240px_auto]">
        <ol class="space-y-4" id="stepper"></ol>
        <form id="application-form" class="space-y-6">
          <div data-step="profile" class="step-panel space-y-4">
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="space-y-1 text-sm text-slate-600">
                Имя
                <input type="text" required placeholder="Иван" class="w-full rounded-xl border-slate-200 text-sm focus:border-slate-900 focus:ring-slate-900" />
              </label>
              <label class="space-y-1 text-sm text-slate-600">
                Фамилия
                <input type="text" required placeholder="Иванов" class="w-full rounded-xl border-slate-200 text-sm focus:border-slate-900 focus:ring-slate-900" />
              </label>
              <label class="space-y-1 text-sm text-slate-600">
                Дата рождения
                <input type="date" required class="w-full rounded-xl border-slate-200 text-sm focus:border-slate-900 focus:ring-slate-900" />
              </label>
              <label class="space-y-1 text-sm text-slate-600">
                Город проживания
                <select required class="w-full rounded-xl border-slate-200 text-sm focus:border-slate-900 focus:ring-slate-900">
                  <option value="" disabled selected>Выберите город</option>
                  <option>Дубай</option>
                  <option>Абу-Даби</option>
                  <option>Шарджа</option>
                  <option>Аджман</option>
                  <option>Рас-эль-Хайма</option>
                  <option>Фуджейра</option>
                </select>
              </label>
              <label class="space-y-1 text-sm text-slate-600">
                Email
                <input type="email" required autocomplete="email" inputmode="email" placeholder="ivan@example.com" class="w-full rounded-xl border-slate-200 text-sm focus:border-slate-900 focus:ring-slate-900" />
              </label>
              <label class="space-y-1 text-sm text-slate-600">
                Номер телефона
                <input type="tel" required autocomplete="tel" inputmode="tel" pattern="^\+?[0-9][0-9\s\-]{7,}$" placeholder="+971 50 123 4567" class="w-full rounded-xl border-slate-200 text-sm focus:border-slate-900 focus:ring-slate-900" />
              </label>
              <fieldset class="space-y-2 sm:col-span-2">
                <legend class="text-sm font-medium text-slate-700">Статус проживания</legend>
                <div class="flex items-center gap-6 text-sm text-slate-700">
                  <label class="inline-flex items-center gap-2">
                    <input type="radio" name="residency-status" value="resident" class="rounded border-slate-300 text-slate-900 focus:ring-slate-900" checked />
                    Резидент ОАЭ
                  </label>
                  <label class="inline-flex items-center gap-2">
                    <input type="radio" name="residency-status" value="nonresident" class="rounded border-slate-300 text-slate-900 focus:ring-slate-900" />
                    Нерезидент
                  </label>
                </div>
                <p class="text-xs text-slate-500">Мы подберем перечень документов в зависимости от статуса.</p>
              </fieldset>
            </div>
          </div>

          <div data-step="documents" class="step-panel hidden space-y-4">
            <p class="text-sm text-slate-600">Загрузите обязательные документы. Дополнительные можно предоставить по запросу.</p>
            <div class="space-y-6" id="documents-list"></div>
          </div>

          <div data-step="summary" class="step-panel hidden space-y-4">
            <article class="rounded-xl bg-slate-50/80 p-5">
              <h2 class="text-sm font-semibold text-slate-800">Сводка</h2>
              <ul class="mt-3 space-y-2 text-sm text-slate-600" id="summary-list"></ul>
            </article>
            <p class="text-sm text-slate-500">После отправки заявки менеджер проверит данные и подготовит договор. Вы сможете подписать его онлайн.</p>
          </div>

          <div class="flex items-center justify-between">
            <button type="button" id="step-back" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:border-slate-900">
              <i data-lucide="arrow-left" class="h-4 w-4"></i>
              Назад
            </button>
            <button type="button" id="step-next" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
              Далее
              <i data-lucide="arrow-right" class="h-4 w-4"></i>
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="module">
    async function getShared(basePath) {
      
      const sharedMod = await import(`${basePath}/shared.js`);
      return { ...sharedMod };
    }

    const shared = await getShared('../../assets');
    const { applyIcons, formatCurrency, loadPricing } = shared;

    const steps = [
      { id: 'profile', title: 'Личные данные', description: 'Паспорт, контакты, адрес проживания, статус' },
      { id: 'documents', title: 'Документы', description: 'Перечень и загрузка необходимых документов' },
      { id: 'summary', title: 'Подтверждение', description: 'Проверьте данные перед отправкой' },
    ];

    let currentStepIndex = 0;

    const stepper = document.getElementById('stepper');
    const stepPanels = document.querySelectorAll('.step-panel');
    const summaryList = document.getElementById('summary-list');

    function renderStepper() {
      stepper.innerHTML = steps
        .map((step, index) => {
          const state = index === currentStepIndex ? 'is-active' : index < currentStepIndex ? 'is-done' : '';
          return `
            <li class="relative pl-10 timeline-step ${state}">
              <span class="step-indicator absolute left-0 top-1 flex h-7 w-7 items-center justify-center rounded-full border border-slate-200 bg-white text-xs font-semibold">${index + 1}</span>
              <div>
                <p class="text-sm font-semibold text-slate-900">${step.title}</p>
                <p class="text-xs text-slate-500">${step.description}</p>
              </div>
            </li>
          `;
        })
        .join('');
      setTimeout(() => {
      applyIcons();
    }, 100);
    }

    function updateSteps() {
      document.getElementById('step-progress').textContent = `${currentStepIndex + 1}/${steps.length}`;
      stepPanels.forEach((panel) => {
        panel.classList.toggle('hidden', panel.dataset.step !== steps[currentStepIndex].id);
      });
      document.getElementById('step-back').disabled = currentStepIndex === 0;
      document.getElementById('step-back').classList.toggle('opacity-50', currentStepIndex === 0);
      document.getElementById('step-next').textContent = currentStepIndex === steps.length - 1 ? 'Отправить заявку' : 'Далее';
      renderStepper();
    }

    document.getElementById('step-next').addEventListener('click', () => {
      if (currentStepIndex === steps.length - 1) {
        const button = document.getElementById('step-next');
        button.innerHTML = '<span class="flex items-center gap-2"><svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><path d="M22 12a10 10 0 0 1-10 10"></path></svg>Отправляем заявку</span>';
        setTimeout(() => {
          window.location.href = '../submitted/index.html';
        }, 800);
        return;
      }
      // Проверка обязательных полей на первом шаге перед переходом
      if (currentStepIndex === 0) {
        const profilePanel = document.querySelector('[data-step="profile"]');
        const requiredFields = profilePanel.querySelectorAll('input[required], select[required]');

        for (const field of requiredFields) {
          const isTextEmpty = field.tagName === 'INPUT' && field.type === 'text' && field.value.trim() === '';
          if (!field.checkValidity() || isTextEmpty) {
            field.setCustomValidity('Заполните это поле');
            field.reportValidity();
            setTimeout(() => field.setCustomValidity(''), 0);
            return;
          }
        }
      }

      currentStepIndex += 1;
      updateSteps();
    });

    document.getElementById('step-back').addEventListener('click', () => {
      if (currentStepIndex === 0) return;
      currentStepIndex -= 1;
      updateSteps();
    });

    const residencyRadios = document.querySelectorAll('input[name="residency-status"]');
    const documentsList = document.getElementById('documents-list');

    // Делегирование: при клике на кнопку "Загрузить" открыть диалог выбора файла
    documentsList.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-file-id]');
      if (!btn) return;
      const fileId = btn.getAttribute('data-file-id');
      const input = documentsList.querySelector(`#${fileId}`);
      if (input) {
        input.click();
      }
    });

    // Показывать имя выбранного файла рядом с кнопкой
    documentsList.addEventListener('change', (e) => {
      const input = e.target;
      if (!(input instanceof HTMLInputElement) || input.type !== 'file') return;
      const docId = input.id.startsWith('file-') ? input.id.substring(5) : input.id;
      const nameSpan = documentsList.querySelector(`[data-file-name-for="${docId}"]`);
      const btn = documentsList.querySelector(`button[data-file-id="${input.id}"]`);
      const file = input.files && input.files[0];
      if (nameSpan) {
        nameSpan.textContent = file ? file.name : '';
      }
      if (btn && file) {
        btn.classList.add('border-slate-900');
      }
    });

    function getRequiredDocuments(status) {
      const common = [
        { id: 'passport', name: 'Паспорт (первая страница и виза/штамп о въезде)', note: '' },
        { id: 'proof-of-address', name: 'Доказательство проживания (utility bill / tenancy contract)', note: '' },
        { id: 'bank-statement', name: 'Выписка из банка за 3–6 месяцев', note: '' },
        { id: 'income-letter', name: 'Справка о доходах или письмо от работодателя', note: '' },
      ];

      const residentOnly = [
        { id: 'emirates-id', name: 'Emirates ID (для резидентов)', note: '' },
        { id: 'aecb', name: 'Кредитный отчёт (Al Etihad Credit Bureau, при необходимости)', note: 'Иногда требуется для резидентов' },
        { id: 'driver-license', name: 'Водительское удостоверение (ОАЭ или международное)', note: '' },
      ];

      const nonResidentOnly = [
        { id: 'foreign-license', name: 'Заграничные водительские права', note: 'Может потребоваться перевод/подтверждение' },
      ];

      if (status === 'resident') {
        return [...residentOnly, ...common];
      }
      return [...nonResidentOnly, ...common];
    }

    function renderDocuments(status) {
      const docs = getRequiredDocuments(status);
      const requiredIds = status === 'resident'
        ? new Set(['passport', 'emirates-id', 'driver-license'])
        : new Set(['passport', 'foreign-license']);

      const requiredDocs = docs.filter(d => requiredIds.has(d.id));
      const optionalDocs = docs.filter(d => !requiredIds.has(d.id));

      function renderDocItem(doc) {
        return `
          <div class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3">
            <div>
              <p class="text-sm font-medium text-slate-900">${doc.name}</p>
              ${doc.note ? `<p class="text-xs text-slate-500">${doc.note}</p>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <input type="file" id="file-${doc.id}" class="sr-only" accept="image/*,.pdf" />
              <span class="text-xs text-slate-500" data-file-name-for="${doc.id}"></span>
              <button type="button" data-file-id="file-${doc.id}" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs text-slate-600 hover:border-slate-900">
                <i data-lucide="upload" class="h-4 w-4"></i>
                Загрузить
              </button>
            </div>
          </div>
        `;
      }

      const requiredSection = `
        <article>
          <h3 class="text-sm font-semibold text-slate-800">Обязательные документы</h3>
          <div class="mt-3 space-y-3">
            ${requiredDocs.map(doc => renderDocItem(doc)).join('')}
          </div>
        </article>
      `;

      const optionalSection = `
        <article>
          <h3 class="text-sm font-semibold text-slate-800">Дополнительные (не обязательные)</h3>
          <div class="mt-3 space-y-3">
            ${optionalDocs.map(doc => renderDocItem(doc)).join('')}
          </div>
        </article>
      `;

      documentsList.innerHTML = requiredSection + optionalSection;
      applyIcons();
    }

    // Initial render based on default radio selection
    const defaultStatus = document.querySelector('input[name="residency-status"]:checked')?.value || 'resident';
    renderDocuments(defaultStatus);

    residencyRadios.forEach((radio) => {
      radio.addEventListener('change', (e) => {
        renderDocuments(e.target.value);
      });
    });

    const params = new URLSearchParams(window.location.search);
    const carId = params.get('car');
    const carNames = {
      'rolls-royce-cullinan': 'Rolls-Royce Cullinan',
      'lamborghini-huracan': 'Lamborghini Huracan',
      'ferrari-488-spider': 'Ferrari 488 Spider',
      'bentley-bentayga': 'Bentley Bentayga',
      'rivian-r1t-adventure': 'Rivian R1T Adventure',
      'volvo-xc40-recharge': 'Volvo XC40 Recharge',
    };
    const pricing = await loadPricing('../../assets');
    const monthly = carId && pricing[carId]?.monthly;
    const buyout = carId && pricing[carId]?.buyout;
    const monthlyText = typeof monthly === 'number' ? formatCurrency(monthly, 'AED') : '—';
    const buyoutText = typeof buyout === 'number' ? formatCurrency(buyout, 'AED') : '—';
    const programText = carId ? `${carNames[carId] || carId} · 36 месяцев` : 'Без выбранной модели · 36 месяцев';

    // Рендер бейджа выбранной модели, если параметр присутствует
    const badgeContainer = document.getElementById('selected-car-badge');
    if (badgeContainer && carId) {
      badgeContainer.innerHTML = `
        <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white">
              <i data-lucide="car" class="h-3 w-3"></i>
              Выбранная модель
            </span>
            <span class="text-sm font-semibold text-slate-900">${carNames[carId] || carId}</span>
            <span class="text-xs text-slate-500">· ${monthlyText}/мес · выкуп ${buyoutText}</span>
          </div>
          
        </div>
      `;
      applyIcons();
    }

    summaryList.innerHTML = `
      <li>Программа: ${programText}</li>
      <li>Условия: ${monthlyText}/мес · выкуп ${buyoutText}</li>
      <li>Документы: 2/3 подтверждены AI</li>
    `;

    updateSteps();
    applyIcons();
  </script>
</body>
</html>
