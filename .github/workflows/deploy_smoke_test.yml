name: Deployment Smoke Tests

on:
  deployment_status:

jobs:
  smoke-test:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Install Supabase CLI
          # Fixed command for installing Supabase CLI
        run: |
          pnpm install -g supabase
          supabase -v

      - name: Create Supabase Branch & Apply Migrations
        id: supabase_branch
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          BRANCH_NAME="e2e-$(date +%s)"
          echo "Creating branch $BRANCH_NAME..."
          # Note: Branching requires Enterprise plan or specific CLI setup.
          # We'll use the CLI to create the branch and push migrations.
          # supabase branches create $BRANCH_NAME
          # supabase db push --branch $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Install Playwright (Chromium only)
        run: pnpm exec playwright install chromium --with-deps

      - name: Run Smoke Tests
        id: playwright_tests
        env:
          BASE_URL: ${{ github.event.deployment_status.target_url }}
          CI: true
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          E2E_CLIENT_EMAIL: ${{ secrets.E2E_CLIENT_EMAIL }}
          E2E_CLIENT_PASSWORD: ${{ secrets.E2E_CLIENT_PASSWORD }}
          E2E_OPS_EMAIL: ${{ secrets.E2E_OPS_EMAIL }}
          E2E_OPS_PASSWORD: ${{ secrets.E2E_OPS_PASSWORD }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SECRET: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pnpm exec playwright test --grep "@smoke" --reporter=dot

      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          RESULT="${{ steps.playwright_tests.outcome }}"
          STATUS_ICON="✅"
          if [ "$RESULT" != "success" ]; then STATUS_ICON="❌"; fi
          
          MESSAGE="<b>E2E Smoke Tests: $STATUS_ICON</b>%0A"
          MESSAGE+="<b>Result:</b> $RESULT%0A"
          MESSAGE+="<b>Deploy URL:</b> ${{ github.event.deployment_status.target_url }}%0A"
          MESSAGE+="<b>Action:</b> <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs & Traces</a>"
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "parse_mode=HTML" \
            -d "text=$MESSAGE"

      - name: Send Failure Screenshots to Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Checking for failure screenshots..."
          find test-results -name "*.png" | while read screenshot; do
            echo "Sending $screenshot..."
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendPhoto" \
              -F "chat_id=$TELEGRAM_CHAT_ID" \
              -F "photo=@$screenshot" \
              -F "caption=Failure screenshot: $(basename $screenshot)"
          done

      - name: Send E2E Videos to Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Checking for test videos..."
          find test-results -name "*.webm" -o -name "*.mp4" | while read video; do
            echo "Sending $video..."
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendVideo" \
              -F "chat_id=$TELEGRAM_CHAT_ID" \
              -F "video=@$video" \
              -F "caption=E2E Video: $(basename $video)"
          done

      - name: Log Test Results to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          STATUS="${{ steps.playwright_tests.outcome }}"
          DEPLOY_URL="${{ github.event.deployment_status.target_url }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST "$SUPABASE_URL/rest/v1/tecor_test_runs" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"project_name\": \"fast-lease\",
              \"status\": \"$STATUS\",
              \"deploy_url\": \"$DEPLOY_URL\",
              \"workflow_run_url\": \"$RUN_URL\",
              \"branch_name\": \"${{ steps.supabase_branch.outputs.branch_name }}\"
            }"

      - name: Cleanup Supabase Branch
        if: always()
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Cleaning up branch ${{ steps.supabase_branch.outputs.branch_name }}..."
          # supabase branches delete ${{ steps.supabase_branch.outputs.branch_name }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: playwright-report
          retention-days: 3
