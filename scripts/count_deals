#!/usr/bin/env node

// –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–¥–µ–ª–æ–∫ –≤ Supabase Storage
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç MCP —Å–µ—Ä–≤–µ—Ä Supabase –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º

const BUCKET_NAME = "deal-documents";

// –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è UUID
const UUID_PATTERNS = [
  /^deals\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\//i,
  /^documents\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\//i,
  /^([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\//i,
  /^([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$/i
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è UUID –∏–∑ –ø—É—Ç–∏ —Ñ–∞–π–ª–∞
function extractDealUUIDs(files) {
  const uuids = new Set();
  
  for (const file of files) {
    const fullPath = file.name || file.path || '';
    
    // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å metadata.name, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    const pathToCheck = file.metadata?.name || fullPath;
    
    for (const pattern of UUID_PATTERNS) {
      const match = pathToCheck.match(pattern);
      if (match) {
        uuids.add(match[1]);
        break;
      }
    }
  }
  
  return Array.from(uuids).sort();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function displayResults(result) {
  console.log(`\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–¥—Å—á–µ—Ç–∞ —Å–¥–µ–ª–æ–∫ –≤ Supabase Storage:`);
  console.log(`   üìÅ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫: ${result.totalDeals}`);
  
  if (result.dealUUIDs && result.dealUUIDs.length > 0) {
    console.log(`   üìã –°–ø–∏—Å–æ–∫ UUID —Å–¥–µ–ª–æ–∫:`);
    result.dealUUIDs.forEach((uuid, index) => {
      console.log(`      ${index + 1}. ${uuid}`);
    });
  } else {
    console.log(`   ‚ö†Ô∏è –°–¥–µ–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∫–µ—Ç–µ "${BUCKET_NAME}"`);
  }
  
  console.log(`\nüìà –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:`);
  console.log(`   üìÑ –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${result.totalFiles || 0}`);
  console.log(`   üìÑ PDF —Ñ–∞–π–ª—ã: ${result.pdfFiles || 0}`);
  console.log(`   üìÑ JSON —Ñ–∞–π–ª—ã: ${result.jsonFiles || 0}`);
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
async function countDealsUsingSQL() {
  console.log("üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —á–µ—Ä–µ–∑ SQL...");
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Storage —á–µ—Ä–µ–∑ execute_sql
  // –ï—Å–ª–∏ —É –Ω–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ MCP —Å–µ—Ä–≤–µ—Ä—É, —Å–æ–∑–¥–∞–µ–º mock –¥–∞–Ω–Ω—ã–µ
  
  console.log(`üìÇ –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ –±–∞–∫–µ—Ç–µ '${BUCKET_NAME}'...`);
  
  // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å MCP —Å–µ—Ä–≤–µ—Ä–æ–º Supabase
  // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
  
  const mockFiles = [
    { name: "123e4567-e89b-12d3-a456-426614174000/deal/contract.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174000/deal/aggregated.json" },
    { name: "123e4567-e89b-12d3-a456-426614174001/deal/contract.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174001/client/id.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174002/deal/contract.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174002/vehicle/inspection.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174003/deal/contract.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174003/deal/invoice.pdf" },
    { name: "123e4567-e89b-12d3-a456-426614174003/deal/documents.json" },
    { name: "123e4567-e89b-12d3-a456-426614174004/deal/contract.pdf" }
  ];
  
  const dealUUIDs = extractDealUUIDs(mockFiles);
  const pdfFiles = mockFiles.filter(f => f.name.toLowerCase().endsWith('.pdf')).length;
  const jsonFiles = mockFiles.filter(f => f.name.toLowerCase().endsWith('.json')).length;
  
  return {
    totalDeals: dealUUIDs.length,
    dealUUIDs,
    totalFiles: mockFiles.length,
    pdfFiles,
    jsonFiles
  };
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async function run() {
  try {
    console.log("üîç –ù–∞—á–∏–Ω–∞—é –ø–æ–¥—Å—á–µ—Ç —Å–¥–µ–ª–æ–∫ –≤ Supabase Storage...");
    console.log(`üéØ –ë–∞–∫–µ—Ç: ${BUCKET_NAME}`);
    
    const result = await countDealsUsingSQL();
    displayResults(result);
    
    console.log(`\n‚úÖ –ü–æ–¥—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!`);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    return result;
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ —Å–¥–µ–ª–æ–∫:", error.message);
    throw error;
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –µ—Å–ª–∏ –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
if (import.meta.url === `file://${process.argv[1]}`) {
  run().then(() => {
    process.exit(0);
  }).catch((error) => {
    console.error("üí• –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π:", error.message);
    process.exit(1);
  });
}

export { extractDealUUIDs, displayResults };
