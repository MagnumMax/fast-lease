<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fast Lease — Deal details FL-2025-1042</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        },
      },
    };
  </script>
  <link rel="stylesheet" href="../../../assets/style.css" />
</head>
<body class="bg-slate-50 font-sans text-slate-900">
  <div class="min-h-screen lg:flex">
    <aside id="sidebar" class="hidden w-72 border-r border-slate-200 bg-white lg:flex"></aside>
    <div class="flex-1">
      <header id="page-header" class="border-b border-slate-200 bg-white/80 px-6 py-5 backdrop-blur"></header>
      <main class="bg-slate-50">
      <div class="mx-auto w-full max-w-6xl lg:ml-0 lg:mr-auto space-y-6">
          <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="grid gap-6 md:grid-cols-[1fr_320px] md:grid-rows-[auto_1fr] items-stretch">
              <!-- Left: title/subtitle -->
              <div>
                <div class="flex items-center gap-2">
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Deal</p>
                  <span class="badge badge-success">Active</span>
                </div>
                <h1 class="mt-2 text-2xl font-semibold text-slate-900">FL-2025-1042 · Rolls-Royce Cullinan</h1>
                <p class="text-sm text-slate-500">Lease-to-own program for 36 months. Created on December 12, 2024.</p>
              </div>

              <!-- Mobile image -->
              <div class="md:hidden">
                <figure class="h-40 overflow-hidden rounded-xl border border-slate-200 shadow-sm">
                  <img
                    src="../../../assets/images/rolls-royce-cullinan-exterior.jpg"
                    alt="Rolls-Royce Cullinan"
                    class="h-full w-full object-cover"
                    loading="lazy"
                    onerror="this.src='https://placehold.co/560x320?text=No+Image'"
                  />
                </figure>
              </div>

              <!-- Right: image spans full block height on desktop -->
              <div class="hidden md:block row-span-2">
                <figure class="h-full overflow-hidden rounded-xl border border-slate-200 shadow-sm">
                  <img
                    src="../../../assets/images/rolls-royce-cullinan-exterior.jpg"
                    alt="Rolls-Royce Cullinan"
                    class="h-full w-full object-cover"
                    loading="lazy"
                    onerror="this.src='https://placehold.co/560x320?text=No+Image'"
                  />
                </figure>
              </div>

              <!-- Bottom-left: KPI cards -->
              <div class="grid gap-3 grid-cols-3">
                <div class="rounded-xl bg-slate-50/80 p-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Monthly payment</p>
                  <p class="mt-1 text-sm font-semibold text-slate-900" id="deal-payment">—</p>
                </div>
                <div class="rounded-xl bg-slate-50/80 p-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Next payment</p>
                  <p class="mt-1 text-sm font-semibold text-slate-900" id="deal-next-payment">—</p>
                </div>
                <div class="rounded-xl bg-slate-50/80 p-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Due amount</p>
                  <p class="mt-1 text-sm font-semibold text-slate-900" id="deal-remaining">—</p>
                </div>
              </div>
            </div>
          </section>

          <section class="rounded-2xl border border-slate-200 bg-white shadow-sm">
            <div class="flex flex-col gap-4 border-b border-slate-200 px-6 py-4 md:flex-row md:items-center md:justify-between">
              <div class="flex flex-wrap items-center gap-2">
                <button data-tab="summary" class="deal-tab rounded-xl px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Summary</button>
                <button data-tab="plan" class="deal-tab rounded-xl px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Payment schedule</button>
                <button data-tab="docs" class="deal-tab rounded-xl px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Deal documents</button>
                <button data-tab="car-docs" class="deal-tab rounded-xl px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Vehicle documents</button>
                <button data-tab="services" class="deal-tab rounded-xl px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Services</button>
                <button data-tab="history" class="deal-tab rounded-xl px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">History</button>
              </div>
            </div>

            <div class="space-y-6 p-6">
              <div data-tab="summary" class="tab-panel space-y-6">
                <div class="grid gap-6 lg:grid-cols-2">
                  <article class="rounded-2xl border border-slate-200 bg-slate-50/60 p-5">
                    <h2 class="text-sm font-semibold text-slate-800">Key information</h2>
                    <dl class="mt-4 space-y-3 text-sm text-slate-600">
                      <div class="flex justify-between"><dt>VIN</dt><dd>5YJSA1E26LF123456</dd></div>
                      <div class="flex justify-between"><dt>Program Term</dt><dd>36 months</dd></div>
                      <div class="flex justify-between"><dt>Issue Date</dt><dd>12.12.2024</dd></div>
                      <div class="flex justify-between"><dt>Mileage</dt><dd>18 400 km</dd></div>
                    </dl>
                  </article>

                  <article class="rounded-2xl border border-slate-200 bg-white p-5">
                    <h2 class="text-sm font-semibold text-slate-800">Deal KPI Chart</h2>
                    <canvas id="dealChart" height="220"></canvas>
                  </article>
                </div>
              </div>

              <div data-tab="plan" class="tab-panel hidden">
                <div id="payment-plan"></div>
              </div>

              <div data-tab="docs" class="tab-panel hidden space-y-6">
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Deal documents</h3>
                  <ul id="deal-documents" class="mt-4 space-y-3"></ul>
                  <div class="mt-4 flex items-center justify-between">
                    <button id="add-doc" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                      <i data-lucide="upload" class="h-4 w-4"></i>
                      Upload documents
                    </button>
                    <span class="text-xs text-slate-500">PDF, JPG, PNG up to 10MB</span>
                  </div>
                  <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png" class="sr-only" id="client-docs-upload" />
                  <div id="uploaded-docs" class="mt-3 space-y-3"></div>
                </div>
              </div>

              <div data-tab="car-docs" class="tab-panel hidden space-y-6">
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Vehicle documents</h3>
                  <ul id="car-documents" class="mt-4 space-y-3"></ul>
                  <div class="mt-4 flex items-center justify-between">
                    <button id="car-add-doc" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                      <i data-lucide="upload" class="h-4 w-4"></i>
                      Upload documents
                    </button>
                    <span class="text-xs text-slate-500">PDF, JPG, PNG up to 10MB</span>
                  </div>
                  <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png" class="sr-only" id="car-docs-upload" />
                  <div id="car-uploaded-docs" class="mt-3 space-y-3"></div>
                </div>

                <div class="pt-2">
                  <h3 class="text-lg font-semibold text-slate-900">Delivery photos</h3>
                  <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3" id="car-delivery-photos"></div>
                  <div class="mt-4 flex items-center justify-between">
                    <button id="car-add-photo" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                      <i data-lucide="upload" class="h-4 w-4"></i>
                      Upload photos
                    </button>
                    <span class="text-xs text-slate-500">JPG, PNG up to 10MB</span>
                  </div>
                  <input type="file" multiple accept=".jpg,.jpeg,.png" class="sr-only" id="car-photos-upload" />
                </div>

                <div class="pt-2">
                  <h3 class="text-lg font-semibold text-slate-900">Periodic inspections</h3>
                  <div id="car-inspections" class="mt-4 space-y-4"></div>
                  <div class="mt-4 flex items-center justify-between">
                    <button id="car-add-inspection-photos" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                      <i data-lucide="upload" class="h-4 w-4"></i>
                      Add inspection photos
                    </button>
                    <span class="text-xs text-slate-500">Select inspection date, JPG/PNG up to 10MB</span>
                  </div>
                  <input type="file" multiple accept=".jpg,.jpeg,.png" class="sr-only" id="car-inspection-photos-upload" />
                </div>
              </div>

              <div data-tab="services" class="tab-panel hidden space-y-4">
                <h3 class="text-lg font-semibold text-slate-900">Service schedule and confirmations</h3>
                <div id="services-list" class="space-y-3"></div>
                <p class="mt-2 text-[11px] text-slate-500">To confirm service, upload 6 photos: front, rear, left and right sides, dashboard, service sticker. JPG/PNG up to 10MB.</p>
              </div>

              <div data-tab="history" class="tab-panel hidden space-y-4">
                <ul id="deal-history" class="space-y-3"></ul>
              </div>
            </div>
          </section>
        </div>
      </main>
  </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <nav id="mobile-bottom-nav" class="mobile-bottom-nav"></nav>
  
  <!-- Service Photos Modal -->
  <div id="service-photo-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/50" data-close-modal></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl border border-slate-200">
        <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
          <h3 class="text-sm font-semibold text-slate-900" id="service-modal-title">Upload service photos</h3>
          <button class="text-slate-400 hover:text-slate-600" data-close-modal><i data-lucide="x" class="h-5 w-5"></i></button>
        </div>
        <div class="p-5">
          <p class="text-xs text-slate-500">Upload one photo for each angle</p>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4" id="service-modal-slots">
            <!-- Перед -->
            <div class="rounded-xl border border-slate-200 p-3">
              <p class="text-xs font-medium text-slate-700">Front</p>
              <div class="mt-2 flex items-center gap-3">
                <div class="h-16 w-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center">
                  <img data-slot-preview="front" class="h-full w-full object-cover hidden" />
                  <i data-lucide="image" class="h-5 w-5 text-slate-400" data-slot-empty="front"></i>
                </div>
                <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-pick-slot="front">
                  <i data-lucide="upload" class="h-4 w-4"></i>Choose photo
                </button>
              </div>
            </div>
            <!-- Зад -->
            <div class="rounded-xl border border-slate-200 p-3">
              <p class="text-xs font-medium text-slate-700">Rear</p>
              <div class="mt-2 flex items-center gap-3">
                <div class="h-16 w-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center">
                  <img data-slot-preview="rear" class="h-full w-full object-cover hidden" />
                  <i data-lucide="image" class="h-5 w-5 text-slate-400" data-slot-empty="rear"></i>
                </div>
                <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-pick-slot="rear">
                  <i data-lucide="upload" class="h-4 w-4"></i>Choose photo
                </button>
              </div>
            </div>
            <!-- Левый бок -->
            <div class="rounded-xl border border-slate-200 p-3">
              <p class="text-xs font-medium text-slate-700">Left side</p>
              <div class="mt-2 flex items-center gap-3">
                <div class="h-16 w-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center">
                  <img data-slot-preview="left" class="h-full w-full object-cover hidden" />
                  <i data-lucide="image" class="h-5 w-5 text-slate-400" data-slot-empty="left"></i>
                </div>
                <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-pick-slot="left">
                  <i data-lucide="upload" class="h-4 w-4"></i>Choose photo
                </button>
              </div>
            </div>
            <!-- Правый бок -->
            <div class="rounded-xl border border-slate-200 p-3">
              <p class="text-xs font-medium text-slate-700">Right side</p>
              <div class="mt-2 flex items-center gap-3">
                <div class="h-16 w-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center">
                  <img data-slot-preview="right" class="h-full w-full object-cover hidden" />
                  <i data-lucide="image" class="h-5 w-5 text-slate-400" data-slot-empty="right"></i>
                </div>
                <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-pick-slot="right">
                  <i data-lucide="upload" class="h-4 w-4"></i>Choose photo
                </button>
              </div>
            </div>
            <!-- Дашборд -->
            <div class="rounded-xl border border-slate-200 p-3">
              <p class="text-xs font-medium text-slate-700">Dashboard</p>
              <div class="mt-2 flex items-center gap-3">
                <div class="h-16 w-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center">
                  <img data-slot-preview="dashboard" class="h-full w-full object-cover hidden" />
                  <i data-lucide="image" class="h-5 w-5 text-slate-400" data-slot-empty="dashboard"></i>
                </div>
                <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-pick-slot="dashboard">
                  <i data-lucide="upload" class="h-4 w-4"></i>Choose photo
                </button>
              </div>
            </div>
            <!-- Стикер ТО -->
            <div class="rounded-xl border border-slate-200 p-3">
              <p class="text-xs font-medium text-slate-700">Service sticker</p>
              <div class="mt-2 flex items-center gap-3">
                <div class="h-16 w-24 overflow-hidden rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center">
                  <img data-slot-preview="sticker" class="h-full w-full object-cover hidden" />
                  <i data-lucide="image" class="h-5 w-5 text-slate-400" data-slot-empty="sticker"></i>
                </div>
                <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-pick-slot="sticker">
                  <i data-lucide="upload" class="h-4 w-4"></i>Choose photo
                </button>
              </div>
            </div>
          </div>
          <input type="file" accept=".jpg,.jpeg,.png" class="sr-only" id="service-modal-file" />
        </div>
        <div class="flex items-center justify-between gap-3 px-5 py-4 border-t border-slate-200">
          <span class="text-xs text-slate-500">JPG/PNG up to 10MB. All 6 photos are required.</span>
          <div class="flex gap-2">
            <button class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 hover:border-slate-900" data-close-modal>Cancel</button>
            <button id="service-modal-save" class="rounded-lg bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="module">
    async function getShared(basePath) {
      
      const sharedMod = await import(`${basePath}/shared.js`);
      return { ...sharedMod };
    }

    const shared = await getShared('../../../assets');
    const { mountSidebar, mountHeader, applyIcons, formatCurrency, formatDate, renderTable, bindTabs, mountMobileBottomNav, loadPricing, statusBadge } = shared;
    const { clientNav } = shared;

    const basePath = '../../..';
    mountSidebar({
      containerId: 'sidebar',
      role: 'Client',
      items: clientNav,
      activePath: '/client/deals/deal-001/index.html',
      basePath,
    });

    mountHeader({
      containerId: 'page-header',
      title: 'Deal details FL-2025-1042',
      breadcrumbs: ['Client', 'Deals', 'Rolls-Royce Cullinan'],
      basePath,
    });

    // Mount mobile bottom navigation
    mountMobileBottomNav({
      containerId: 'mobile-bottom-nav',
      items: clientNav,
      activePath: '/client/deals/deal-001/index.html',
      basePath,
    });

    bindTabs({ triggersSelector: '.deal-tab', panelsSelector: '.tab-panel' });
    document.querySelector('[data-tab="summary"]').classList.add('bg-slate-900', 'text-white');

    const pricing = await loadPricing('../../../assets');
    const carId = 'rolls-royce-cullinan';
    const monthly = pricing[carId]?.monthly ?? 3260;
    const buyout = pricing[carId]?.buyout ?? 106000;
    const deal = {
      payment: monthly,
      nextPayment: '2025-11-15',
      remainingBuyout: buyout,
    };

    document.getElementById('deal-payment').textContent = formatCurrency(deal.payment, 'AED');
    document.getElementById('deal-next-payment').textContent = formatDate(deal.nextPayment);
    document.getElementById('deal-remaining').textContent = formatCurrency(deal.remainingBuyout, 'AED');

    const kpiChart = new Chart(document.getElementById('dealChart'), {
      type: 'line',
      data: {
        labels: ['Dec', 'Jan', 'Nov', 'Dec', 'Jan', 'Feb'],
        datasets: [
          {
            label: 'Payments',
            data: [monthly, monthly, monthly, monthly, monthly, monthly],
            borderColor: '#2563eb',
            tension: 0.4,
          },
          {
            label: 'Buyout remaining',
            data: [114500, 110800, 107500, 104200, 101100, 97800],
            borderColor: '#cbd5f5',
            borderDash: [6, 6],
            tension: 0.4,
          },
        ],
      },
      options: {
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: false } },
      },
    });

    const planColumns = [
      { key: 'number', label: '#' },
      {
        key: 'dueDate',
        label: 'Date',
        render: (row) => formatDate(row.dueDate),
      },
      {
        key: 'amount',
        label: 'Amount',
        render: (row) => formatCurrency(row.amount, 'AED'),
      },
      {
        key: 'status',
        label: 'Status',
        render: (row) => `<span class="badge ${row.status === 'Paid' ? 'badge-success' : row.status === 'Planned' ? 'badge-info' : 'badge-warning'}">${row.status}</span>`,
      },
    ];

    const paymentPlan = [
      { number: 13, dueDate: '2025-11-15', amount: monthly, status: 'Planned' },
      { number: 12, dueDate: '2025-01-15', amount: monthly, status: 'Overdue' },
      { number: 11, dueDate: '2024-12-15', amount: monthly, status: 'Paid' },
      { number: 10, dueDate: '2024-11-15', amount: monthly, status: 'Paid' },
      { number: 9, dueDate: '2024-10-15', amount: monthly, status: 'Paid' },
    ];

    renderTable({ containerId: 'payment-plan', columns: planColumns, data: paymentPlan });

    const documents = [
      {
        title: 'Lease agreement',
        status: 'Signed on 12/12/2024',
        action: 'Download PDF',
      },
      {
        title: 'Payment schedule (update)',
        status: 'Version 02/2025',
        action: 'Open',
      },
      {
        title: 'Delivery acceptance form',
        status: 'Signature pending',
        action: 'Sign',
      },
    ];

    const documentsContainer = document.getElementById('deal-documents');
    documentsContainer.innerHTML = documents
      .map(
        (doc) => `
        <div class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3">
          <div>
            <p class="text-sm font-medium text-slate-900">${doc.title}</p>
            <p class="text-xs text-slate-500">${doc.status}</p>
          </div>
          <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900">
            <i data-lucide="download" class="h-4 w-4"></i>${doc.action}
          </button>
        </div>
      `
      )
      .join('');
    // Simplified document upload
    const uploadedDocsContainer = document.getElementById('uploaded-docs');
    const fileInput = document.getElementById('client-docs-upload');
    const addDocBtn = document.getElementById('add-doc');
    let uploadedFiles = [];

    addDocBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const files = [...e.target.files];
      files.forEach(file => {
        uploadedFiles.push({
          file,
          id: Date.now() + Math.random(),
          uploadDate: new Date().toISOString(),
        });
      });
      updateUploadedDocsDisplay();
      e.target.value = '';
    });

    function updateUploadedDocsDisplay() {
      uploadedDocsContainer.innerHTML = uploadedFiles
        .map(
          (item) => `
          <div class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3" id="doc-${item.id}">
            <div class="flex items-center gap-3">
              <div class="h-8 w-8 rounded-full bg-emerald-50 flex items-center justify-center">
                <i data-lucide="check-circle" class="h-4 w-4 text-emerald-600"></i>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-900">${item.file.name}</p>
                <p class="text-xs text-slate-500">${formatFileSize(item.file.size)} • Uploaded ${formatDate(item.uploadDate)}</p>
              </div>
            </div>
            <button onclick="removeUploadedFile(${item.id})" class="text-slate-400 hover:text-slate-600">
              <i data-lucide="trash-2" class="h-4 w-4"></i>
            </button>
          </div>
        `
        )
        .join('');
      applyIcons();
    }

    window.removeUploadedFile = function(id) {
      uploadedFiles = uploadedFiles.filter(item => item.id !== id);
      const docElement = document.getElementById(`doc-${id}`);
      if (docElement) {
        docElement.remove();
      }
    };

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Vehicle documents
    const carDocuments = [
      {
        title: 'Registration Certificate (Mulkiya)',
        status: 'Valid until 12.12.2025',
        action: 'Download PDF',
      },
      {
        title: 'Insurance Policy',
        status: 'Version 2025',
        action: 'Open',
      },
      {
        title: 'Inspection Protocol',
        status: 'Passed 01.2025',
        action: 'Download',
      },
      {
        title: 'Vehicle Usage Rules',
        status: 'Current',
        action: 'Open',
      },
    ];

    const carDocumentsContainer = document.getElementById('car-documents');
    carDocumentsContainer.innerHTML = carDocuments
      .map(
        (doc) => `
        <div class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3">
          <div>
            <p class="text-sm font-medium text-slate-900">${doc.title}</p>
            <p class="text-xs text-slate-500">${doc.status}</p>
          </div>
          <button class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900">
            <i data-lucide="download" class="h-4 w-4"></i>${doc.action}
          </button>
        </div>
      `
      )
      .join('');

    // Simplified vehicle document upload
    const carUploadedDocsContainer = document.getElementById('car-uploaded-docs');
    const carFileInput = document.getElementById('car-docs-upload');
    const carAddDocBtn = document.getElementById('car-add-doc');
    let carUploadedFiles = [];

    carAddDocBtn?.addEventListener('click', () => carFileInput.click());
    carFileInput?.addEventListener('change', (e) => {
      const files = [...e.target.files];
      files.forEach(file => {
        carUploadedFiles.push({
          file,
          id: Date.now() + Math.random(),
          uploadDate: new Date().toISOString(),
        });
      });
      updateCarUploadedDocsDisplay();
      e.target.value = '';
    });

    function updateCarUploadedDocsDisplay() {
      carUploadedDocsContainer.innerHTML = carUploadedFiles
        .map(
          (item) => `
          <div class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3" id="car-doc-${item.id}">
            <div class="flex items-center gap-3">
              <div class="h-8 w-8 rounded-full bg-emerald-50 flex items-center justify-center">
                <i data-lucide="check-circle" class="h-4 w-4 text-emerald-600"></i>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-900">${item.file.name}</p>
                <p class="text-xs text-slate-500">${formatFileSize(item.file.size)} • Uploaded ${formatDate(item.uploadDate)}</p>
              </div>
            </div>
            <button onclick="removeCarUploadedFile(${item.id})" class="text-slate-400 hover:text-slate-600">
              <i data-lucide="trash-2" class="h-4 w-4"></i>
            </button>
          </div>
        `
        )
        .join('');
      applyIcons();
    }

    window.removeCarUploadedFile = function(id) {
      carUploadedFiles = carUploadedFiles.filter(item => item.id !== id);
      const docElement = document.getElementById(`car-doc-${id}`);
      if (docElement) {
        docElement.remove();
      }
    };

    // Delivery photos
    const deliveryPhotosContainer = document.getElementById('car-delivery-photos');
    const carPhotosFileInput = document.getElementById('car-photos-upload');
    const carAddPhotoBtn = document.getElementById('car-add-photo');
    let deliveryPhotos = [
      { src: '../../../assets/images/rolls-royce-cullinan-exterior.jpg', caption: '12.12.2024 • Delivery' },
      { src: '../../../assets/images/rolls-royce-cullinan-exterior.jpg', caption: '12.12.2024 • Delivery' },
      { src: '../../../assets/images/rolls-royce-cullinan-exterior.jpg', caption: '12.12.2024 • Delivery' },
    ];

    function renderDeliveryPhotos() {
      deliveryPhotosContainer.innerHTML = deliveryPhotos
        .map(
          (p) => `
          <figure class="overflow-hidden rounded-xl border border-slate-200 bg-white">
            <img src="${p.src}" alt="Car photo" class="h-28 w-full object-cover" />
            <figcaption class="px-3 py-2 text-xs text-slate-600">${p.caption}</figcaption>
          </figure>
        `
        )
        .join('');
    }
    renderDeliveryPhotos();

    carAddPhotoBtn?.addEventListener('click', () => carPhotosFileInput.click());
    carPhotosFileInput?.addEventListener('change', (e) => {
      const files = [...e.target.files];
      files.forEach(file => {
        const url = URL.createObjectURL(file);
        deliveryPhotos.push({ src: url, caption: `${formatDate(new Date().toISOString())} • Upload` });
      });
      renderDeliveryPhotos();
      e.target.value = '';
    });

    // Periodic inspections (grouped by dates)
    const inspectionsContainer = document.getElementById('car-inspections');
    const inspectionPhotosFileInput = document.getElementById('car-inspection-photos-upload');
    const addInspectionPhotosBtn = document.getElementById('car-add-inspection-photos');

    let inspections = [
      {
        date: '2025-02-20',
        photos: ['../../../assets/images/rolls-royce-cullinan-exterior.jpg'],
        note: 'Scheduled inspection 20.02.2025',
      },
      {
        date: '2025-01-02',
        photos: ['../../../assets/images/rolls-royce-cullinan-exterior.jpg'],
        note: 'Initial inspection after delivery',
      },
    ];

    function renderInspections() {
      const sorted = [...inspections].sort((a, b) => new Date(b.date) - new Date(a.date));
      inspectionsContainer.innerHTML = sorted
        .map(
          (ins) => `
          <section class="rounded-2xl border border-slate-200 bg-slate-50/60 p-4">
            <div class="flex items-center justify-between">
              <h4 class="text-sm font-semibold text-slate-800">${formatDate(ins.date)}</h4>
              ${ins.note ? `<span class="text-xs text-slate-500">${ins.note}</span>` : ''}
            </div>
            <div class="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3">
              ${ins.photos
                .map(
                  (src) => `
                  <figure class="overflow-hidden rounded-xl border border-slate-200 bg-white">
                    <img src="${src}" alt="Inspection photo" class="h-28 w-full object-cover" />
                    <figcaption class="px-3 py-2 text-[11px] text-slate-500">Inspection</figcaption>
                  </figure>
                `
                )
                .join('')}
            </div>
          </section>
        `
        )
        .join('');
    }
    renderInspections();

    addInspectionPhotosBtn?.addEventListener('click', () => inspectionPhotosFileInput.click());
    inspectionPhotosFileInput?.addEventListener('change', (e) => {
      const dateInput = prompt('Enter inspection date (YYYY-MM-DD)');
      const files = [...e.target.files];
      if (!dateInput) { e.target.value = ''; return; }
      const date = new Date(dateInput);
      if (isNaN(date.getTime())) { alert('Invalid date'); e.target.value = ''; return; }
      const existing = inspections.find(i => i.date === dateInput);
      const urls = files.map(f => URL.createObjectURL(f));
      if (existing) {
        existing.photos.push(...urls);
      } else {
        inspections.push({ date: dateInput, photos: urls, note: '' });
      }
      renderInspections();
      e.target.value = '';
    });
    
    // Services (ТО) — data, UI and interactions
    const services = [
      {
        id: 'insp-2025-01-02',
        name: 'Initial inspection',
        type: 'Inspection',
        dueDate: '2025-01-02',
        mileageDue: null,
        completedAt: '2025-01-02',
        attachments: [{ url: '../../../assets/images/rolls-royce-cullinan-exterior.jpg' }],
      },
      {
        id: 'to-1-2025-02-20',
        name: 'Maintenance #1 (oil and filters)',
        type: 'Maintenance',
        dueDate: '2025-02-20',
        mileageDue: 20000,
        completedAt: null,
        attachments: [],
      },
      {
        id: 'oil-2025-06-15',
        name: 'Oil and filter change',
        type: 'Maintenance',
        dueDate: '2025-06-15',
        mileageDue: 30000,
        completedAt: null,
        attachments: [],
      },
      {
        id: 'annual-2025-12-12',
        name: 'Annual inspection',
        type: 'Inspection',
        dueDate: '2025-12-12',
        mileageDue: null,
        completedAt: null,
        attachments: [],
      },
    ];

    function getServiceStatus(svc) {
      if (svc.completedAt) return 'Completed';
      const due = new Date(svc.dueDate);
      const today = new Date();
      const todayMid = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      if (due < todayMid) return 'Overdue';
      const days = Math.ceil((due - todayMid) / (1000 * 60 * 60 * 24));
      if (days <= 14) return 'Requires action';
      return 'Planned';
    }

    // Required photo slots for each service confirmation
    const REQUIRED_SLOTS = [
      { key: 'front', label: 'Front' },
      { key: 'rear', label: 'Rear' },
      { key: 'left', label: 'Left side' },
      { key: 'right', label: 'Right side' },
      { key: 'dashboard', label: 'Dashboard' },
      { key: 'sticker', label: 'Service sticker' },
    ];
 
    function getMissingSlots(svc) {
      const atts = Array.isArray(svc.attachments) ? svc.attachments : [];
      return REQUIRED_SLOTS.filter(sl => !atts.some(a => a.slot === sl.key)).map(sl => sl.key);
    }
 
    function countFilledSlots(attachments) {
      const atts = Array.isArray(attachments) ? attachments : [];
      return REQUIRED_SLOTS.filter(sl => atts.some(a => a.slot === sl.key)).length;
    }

    function renderServices() {
      const container = document.getElementById('services-list');
      if (!container) return;
 
      container.innerHTML = services
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
        .map((s) => {
          const st = getServiceStatus(s);
          const filled = countFilledSlots(s.attachments);
          const ready = filled === 6;
          const dueMeta = `Due: ${formatDate(s.dueDate)}${s.mileageDue ? ' • ' + s.mileageDue.toLocaleString('en-US') + ' km' : ''}${s.completedAt ? ` • Completed: ${formatDate(s.completedAt)}` : ''}`;
          return `
            <div class="rounded-xl border border-slate-200 px-4 py-3">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <p class="text-sm font-medium text-slate-900">${s.name}</p>
                  <p class="mt-0.5 text-xs text-slate-500">${dueMeta}</p>
                  <p class="mt-1 text-[11px] text-slate-500">Photos: ${filled}/6</p>
                </div>
                ${statusBadge(st)}
              </div>
              <div class="mt-3 grid grid-cols-2 gap-2 sm:flex sm:flex-wrap sm:gap-2">
                <button class="btn-open-service-modal inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 hover:border-slate-900" data-service-id="${s.id}">
                  <i data-lucide="upload" class="h-4 w-4"></i>
                  Upload 6 photos
                </button>
                ${s.completedAt ? '' : `
                <button class="btn-complete-service inline-flex items-center gap-2 rounded-lg ${ready ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-emerald-600/50 text-white cursor-not-allowed'} px-3 py-2 text-xs font-semibold" data-service-id="${s.id}" ${ready ? '' : 'disabled title="Add all 6 photos"'}>
                  <i data-lucide="check-circle" class="h-4 w-4"></i>
                  Mark as completed
                </button>
                `}
              </div>
              ${(Array.isArray(s.attachments) && s.attachments.length) ? `
                <div class="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-3" id="service-photos-${s.id}">
                  ${s.attachments.map(a => {
                    const lbl = (REQUIRED_SLOTS.find(x => x.key === a.slot) || {}).label || 'Photo';
                    return `
                      <figure class="overflow-hidden rounded-lg border border-slate-200 bg-white">
                        <img src="${a.url}" alt="${lbl}" class="h-24 w-full object-cover" />
                        <figcaption class="px-2 py-1 text-[10px] text-slate-500">${lbl}</figcaption>
                      </figure>
                    `;
                  }).join('')}
                </div>
              ` : `<div class="mt-3" id="service-photos-${s.id}"></div>`}
            </div>
          `;
        })
        .join('');
 
      // Bind actions
      const uploadBtns = container.querySelectorAll('.btn-open-service-modal');
      uploadBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const sid = btn.getAttribute('data-service-id');
          openServicePhotoModal(sid);
        });
      });
 
      const completeBtns = container.querySelectorAll('.btn-complete-service');
      completeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-service-id');
          const s = services.find(x => x.id === id);
          if (!s) return;
          const filled = countFilledSlots(s.attachments);
          if (filled < 6) {
            openServicePhotoModal(id);
            return;
          }
          s.completedAt = new Date().toISOString();
          renderServices();
        });
      });
 
      applyIcons();
    }

    // Modal logic for uploading the 6 required photos
    const modalEl = document.getElementById('service-photo-modal');
    const modalFileInput = document.getElementById('service-modal-file');
    const modalTitleEl = document.getElementById('service-modal-title');
    let modalCurrentServiceId = null;
    let modalPicked = {}; // slot -> File or existing attachment
 
    function openServicePhotoModal(serviceId) {
      modalCurrentServiceId = serviceId;
      modalPicked = {};
      const svc = services.find(s => s.id === serviceId);
      if (modalTitleEl) modalTitleEl.textContent = `Upload service photos — ${svc?.name || ''}`;
 
      // Reset previews and fill existing
      REQUIRED_SLOTS.forEach(sl => {
        const img = document.querySelector(`[data-slot-preview="${sl.key}"]`);
        const empty = document.querySelector(`[data-slot-empty="${sl.key}"]`);
        if (img) { img.src = ''; img.classList.add('hidden'); }
        if (empty) empty.classList.remove('hidden');
        const existing = svc?.attachments?.find(a => a.slot === sl.key);
        if (existing && img && empty) {
          img.src = existing.url;
          img.classList.remove('hidden');
          empty.classList.add('hidden');
          modalPicked[sl.key] = existing; // keep existing as pre-filled
        }
      });
 
      modalEl?.classList.remove('hidden');
      applyIcons();
    }
 
    function closeServicePhotoModal() {
      modalEl?.classList.add('hidden');
      modalCurrentServiceId = null;
      modalPicked = {};
    }
 
    // Pick-slot buttons inside modal
    document.querySelectorAll('#service-modal-slots [data-pick-slot]').forEach(btn => {
      btn.addEventListener('click', () => {
        const slot = btn.getAttribute('data-pick-slot');
        if (!slot) return;
        modalFileInput.dataset.slot = slot;
        modalFileInput.click();
      });
    });
 
    // Handle file chosen
    modalFileInput?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      const slot = modalFileInput.dataset.slot;
      if (!file || !slot) return;
      if (file.size > 10 * 1024 * 1024) { alert('File exceeds 10MB'); e.target.value = ''; return; }
 
      modalPicked[slot] = file;
      const url = URL.createObjectURL(file);
      const img = document.querySelector(`[data-slot-preview="${slot}"]`);
      const empty = document.querySelector(`[data-slot-empty="${slot}"]`);
      if (img && empty) {
        img.src = url;
        img.classList.remove('hidden');
        empty.classList.add('hidden');
      }
      e.target.value = '';
    });
 
    // Close modal
    document.querySelectorAll('#service-photo-modal [data-close-modal]').forEach(btn => {
      btn.addEventListener('click', closeServicePhotoModal);
    });
 
    // Save photos to service
    document.getElementById('service-modal-save')?.addEventListener('click', () => {
      const svc = services.find(s => s.id === modalCurrentServiceId);
      if (!svc) { closeServicePhotoModal(); return; }
      const haveAll = REQUIRED_SLOTS.every(sl => modalPicked[sl.key] || (svc.attachments || []).some(a => a.slot === sl.key));
      if (!haveAll) { alert('All 6 photos are required'); return; }
 
      svc.attachments = Array.isArray(svc.attachments) ? svc.attachments : [];
      REQUIRED_SLOTS.forEach(sl => {
        const idx = svc.attachments.findIndex(a => a.slot === sl.key);
        let record = null;
        const picked = modalPicked[sl.key];
        if (picked instanceof File) {
          record = { url: URL.createObjectURL(picked), slot: sl.key, name: picked.name, size: picked.size, uploadedAt: new Date().toISOString() };
        } else if (picked && picked.url) {
          record = picked; // keep existing
        } else if (idx >= 0) {
          record = svc.attachments[idx];
        }
        if (record) {
          if (idx >= 0) svc.attachments[idx] = record;
          else svc.attachments.push(record);
        }
      });
 
      closeServicePhotoModal();
      renderServices();
    });

    // Initialize services UI
    renderServices();

    const history = [
      { date: '2025-01-15', note: 'Auto-debit successful', type: 'success' },
      { date: '2025-01-02', note: 'Service receipt uploaded', type: 'info' },
      { date: '2024-12-18', note: 'Acceptance certificate confirmed', type: 'success' },
      { date: '2024-12-10', note: 'AI marked Emirates ID as verified', type: 'info' },
    ];

    const historyContainer = document.getElementById('deal-history');
    historyContainer.innerHTML = history
      .map(
        (item) => `
        <li class="flex items-center gap-4 rounded-xl border border-slate-200 px-4 py-3">
          <div class="h-10 w-10 rounded-full ${item.type === 'success' ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-100 text-slate-600'} flex items-center justify-center">
            <i data-lucide="${item.type === 'success' ? 'check-circle' : 'info'}" class="h-5 w-5"></i>
          </div>
          <div>
            <p class="text-sm font-medium text-slate-900">${item.note}</p>
            <p class="text-xs text-slate-500">${formatDate(item.date)}</p>
          </div>
        </li>
      `
      )
      .join('');

    applyIcons();
  </script>
</body>
</html>
