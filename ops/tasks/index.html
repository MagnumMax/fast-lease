<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fast Lease — Таск-менеджер</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } } };</script>
  <link rel="stylesheet" href="../../assets/style.css" />
  <link rel="stylesheet" href="../../assets/linear.css" />
</head>
<body class="linear light font-sans">
  <div class="min-h-screen lg:flex">
    <aside id="sidebar" class="hidden w-72 border-r border-slate-200 bg-white lg:flex"></aside>
    <div class="flex-1 flex flex-col">
      <header id="page-header" class="border-b border-slate-200 bg-white/80 px-6 py-5 backdrop-blur"></header>
      <main class="flex-1 bg-transparent">
      <div class="mx-auto w-full max-w-6xl lg:ml-0 lg:mr-auto space-y-6">
          
          

          

          <!-- Kanban Board Section -->
          <section id="kanban" class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
            <!-- Kanban columns will render here -->
          </section>
        </div>
      </main>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/30 px-4">
    <div class="w-full max-w-md rounded-2xl border border-slate-200 bg-white p-6 shadow-lg">
      <h2 class="text-lg font-semibold text-slate-900">Создать задачу</h2>
      <form id="modal-form" class="mt-4 space-y-4 text-sm text-slate-600">
        <label class="space-y-1">
          Заголовок
          <input required class="w-full rounded-xl border focus:border-slate-900 focus:ring-slate-900" />
        </label>
        <label class="space-y-1">
          Описание
          <textarea name="description" rows="3" class="w-full rounded-xl border focus:border-slate-900 focus:ring-slate-900"></textarea>
        </label>
        <label class="space-y-1">
          Исполнитель
          <select class="w-full rounded-xl border focus:border-slate-900 focus:ring-slate-900">
            <option>Мария</option>
            <option>Роман</option>
            <option>Анна</option>
          </select>
        </label>
        <label class="space-y-1">
          Дедлайн
          <input type="datetime-local" class="w-full rounded-xl border focus:border-slate-900 focus:ring-slate-900" />
        </label>
        <div class="flex justify-end gap-3">
          <button type="button" data-close-modal class="rounded-xl border px-4 py-2 text-sm">Отменить</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold">
            <i data-lucide="check" class="h-4 w-4"></i>
            Сохранить
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="module">
    async function getShared(basePath) {
      
      const sharedMod = await import(`${basePath}/shared.js`);
      return { ...sharedMod };
    }

    const shared = await getShared('../../assets');
    const { mountSidebar, mountHeader, applyIcons, bindModal, initSortable, formatDate, mountMobileBottomNav } = shared;
    const { opsNav } = shared;

    const basePath = '../..';
    mountSidebar({ containerId: 'sidebar', role: 'Операционный менеджер', items: opsNav, activePath: '/ops/tasks/index.html', basePath });

    mountHeader({
      containerId: 'page-header',
      title: 'Таск-менеджер',
      breadcrumbs: ['Операции', 'Задачи'],
      basePath,
    });

    mountMobileBottomNav({
      containerId: 'mobile-bottom-nav',
      items: opsNav,
      activePath: '/ops/tasks/index.html',
      basePath,
    });

    // Updated tasks with status and creator information
    const tasks = [
      { id: 1, title: 'Перезвонить клиенту APP-2218', owner: 'Мария', due: 'Сегодня · 15:30', priority: 'high', source: 'Ручная', status: 'new', creator: 'user' },
      { id: 2, title: 'Проверить VIN в Odoo (Rolls-Royce Cullinan)', owner: 'Роман', due: 'Сегодня · 17:00', priority: 'normal', source: 'AI', status: 'in-progress', creator: 'ai' },
      { id: 3, title: 'Загрузить акт приема от сервиса', owner: 'Анна', due: 'Завтра · 11:00', priority: 'normal', source: 'Авто', status: 'in-progress', creator: 'system' },
      { id: 4, title: 'Подтвердить оплату INV-2025-012', owner: 'Мария', due: 'Завтра · 14:00', priority: 'high', source: 'Finance', status: 'done', creator: 'system' },
      { id: 5, title: 'Отправить документы в банк', owner: 'Роман', due: 'Пятница · 10:00', priority: 'normal', source: 'Ручная', status: 'new', creator: 'user' },
      { id: 6, title: 'Обновить информацию о страховке', owner: 'Анна', due: 'След. понедельник · 12:00', priority: 'normal', source: 'Авто', status: 'cancelled', creator: 'system' }
    ];

    // Filters helpers

    const readFilters = () => {
      const q = (document.getElementById('tasks-search')?.value || '').trim().toLowerCase();
      const status = document.getElementById('tasks-status')?.value || '';
      return { q, status };
    };

    const filterTasks = (items) => {
      const { q, status } = readFilters();
      return items.filter((t) => {
        const matchesQuery = !q || `${t.title} ${t.owner} ${t.source}`.toLowerCase().includes(q);
        const matchesStatus = !status || t.status === status;
        return matchesQuery && matchesStatus;
      });
    };

    const kanban = document.getElementById('kanban');
    
    // Default status for new task when using column + buttons
    window.defaultStatusForNewTask = null;

    // Function to render tasks in Kanban board (for updates)
    function renderKanbanBoard() {
      // Build statuses from filtered tasks
      const filtered = filterTasks(tasks);
      const updatedStatuses = [
        { title: 'Новые', key: 'new', tasks: filtered.filter(task => task.status === 'new') },
        { title: 'В работе', key: 'in-progress', tasks: filtered.filter(task => task.status === 'in-progress') },
        { title: 'Выполнено', key: 'done', tasks: filtered.filter(task => task.status === 'done') },
        { title: 'Отменено', key: 'cancelled', tasks: filtered.filter(task => task.status === 'cancelled') }
      ];

      // Re-render the Kanban board
      kanban.innerHTML = updatedStatuses
        .map(
          (column) => `
          <article class="flex h-full flex-col rounded-2xl border border-slate-200 bg-transparent p-4 shadow-sm">
            <header class="flex items-center justify-between">
              <h2 class="text-sm font-semibold text-slate-800">${column.title}</h2>
              <div class="flex items-center gap-2">
                ${['new','in-progress'].includes(column.key) ? `
                <button class="create-task inline-flex items-center justify-center rounded-full bg-slate-900 text-white hover:bg-slate-800 h-7 w-7" data-add-task data-status="${column.key}" title="Добавить задачу">
                  <i data-lucide=\"plus\" class="h-4 w-4"></i>
                </button>
                ` : ''}
                <span class="badge badge-info">${column.tasks.length}</span>
              </div>
            </header>
            <div class="mt-4 flex-1 space-y-3" data-column="${column.key}">
              ${column.tasks
                .map(
                  (task) => `
                  <div class="group block rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 hover:border-slate-900 cursor-move" data-id="${task.id}">
                    <div>
                      <span class="font-semibold text-slate-900 block">${task.title}</span>
                    </div>
                    <p class="truncate text-sm text-slate-600">${task.owner}</p>
                    <div class="mt-2 flex items-center justify-between">
                      <span class="badge ${task.priority === 'high' ? 'badge-danger' : 'badge-info'}">${task.priority === 'high' ? 'Высокий' : 'Нормальный'}</span>
                      <span class="text-xs text-slate-500">${task.source}</span>
                    </div>
                    <div class="mt-2 text-xs text-slate-400">${task.due}</div>
                  </div>
                `)
                .join('')}
            </div>
          </article>
        `
        )
        .join('');

      // Re-initialize SortableJS for drag and drop functionality
      updatedStatuses.forEach((column) => {
        initSortable(`[data-column="${column.key}"]`, {
          group: 'tasks',
          animation: 150,
          handle: '.group',
          onEnd: function (evt) {
            // Update task status when moved between columns
            const taskId = parseInt(evt.item.getAttribute('data-id'));
            const newStatus = evt.to.getAttribute('data-column');
            const task = tasks.find(t => t.id === taskId);
            if (task) {
              task.status = newStatus;
              // Re-render the Kanban board reflecting current filters
              renderKanbanBoard();
            }
          }
        });
      });

      setTimeout(() => {
        applyIcons();
        // Bind + buttons in columns to set default status before opening modal
        const addButtons = document.querySelectorAll('[data-add-task]');
        addButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            window.defaultStatusForNewTask = btn.dataset.status || 'new';
          });
        });
      }, 100);
    }

    // Initial render and wiring
    renderKanbanBoard();

    document.getElementById('tasks-search')?.addEventListener('input', () => renderKanbanBoard());
    document.getElementById('tasks-status')?.addEventListener('change', () => renderKanbanBoard());
    document.getElementById('tasks-clear-filters')?.addEventListener('click', () => {
      const s = document.getElementById('tasks-search');
      const st = document.getElementById('tasks-status');
      if (s) s.value = '';
      if (st) st.value = '';
      renderKanbanBoard();
    });

    

    bindModal({ openSelector: '.create-task', modalId: 'modal' });

    // Task detail modal
    const taskDetailModal = (() => {
      const modal = document.getElementById('task-detail-modal');
      const closeBtns = modal ? modal.querySelectorAll('[data-close-modal]') : [];
      const open = () => modal.classList.remove('hidden');
      const close = () => modal.classList.add('hidden');
      closeBtns.forEach(btn => btn.addEventListener('click', close));
      modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
      return { open, close };
    })();

    let currentTaskId = null;
    function openTaskDetail(task) {
      currentTaskId = task.id;
      const titleInput = document.getElementById('task-detail-title-input');
      const descInput = document.getElementById('task-detail-description-input');
      const ownerSelect = document.getElementById('task-detail-owner');
      if (titleInput) titleInput.value = task.title || '';
      if (descInput) descInput.value = task.description || '';
      if (ownerSelect) ownerSelect.value = task.owner;
      document.getElementById('task-detail-due').textContent = task.due;
      const prEl = document.getElementById('task-detail-priority');
      prEl.textContent = task.priority === 'high' ? 'Высокий' : 'Нормальный';
      prEl.className = `badge ${task.priority === 'high' ? 'badge-danger' : 'badge-info'}`;
      document.getElementById('task-detail-source').textContent = task.source;
      taskDetailModal.open();
      applyIcons();
    }

    function bindTaskClicks() {
      document.querySelectorAll('[data-column] .group').forEach(el => {
        el.addEventListener('click', (e) => {
          // Ignore drag events if Sortable is moving
          const id = parseInt(el.getAttribute('data-id'));
          const task = tasks.find(t => t.id === id);
          if (task) openTaskDetail(task);
        });
      });
    }

    // Bind actions in detail modal
    const doneBtn = document.getElementById('task-action-done');
    const cancelBtn = document.getElementById('task-action-cancel');
    const deleteBtn = document.getElementById('task-action-delete');

    doneBtn?.addEventListener('click', () => {
      const task = tasks.find(t => t.id === currentTaskId);
      if (!task) return;
      task.status = 'done';
      renderKanbanBoard();
      bindTaskClicks();
      taskDetailModal.close();
    });

    cancelBtn?.addEventListener('click', () => {
      const task = tasks.find(t => t.id === currentTaskId);
      if (!task) return;
      task.status = 'cancelled';
      renderKanbanBoard();
      bindTaskClicks();
      taskDetailModal.close();
    });

    deleteBtn?.addEventListener('click', () => {
      const idx = tasks.findIndex(t => t.id === currentTaskId);
      if (idx >= 0) {
        tasks.splice(idx, 1);
        renderKanbanBoard();
        bindTaskClicks();
        taskDetailModal.close();
      }
    });

    // Re-bind after each render
    setTimeout(bindTaskClicks, 120);

    document.getElementById('modal-form').addEventListener('submit', (event) => {
      event.preventDefault();
      const button = event.target.querySelector('button[type="submit"]');
      button.innerHTML = '<span class="flex items-center gap-2"><svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><path d="M22 12a10 10 0 0 1-10 10"></path></svg>Создаём</span>';
      
      // Simulate task creation
      setTimeout(() => {
        const formData = new FormData(event.target);
        const newTask = {
          id: tasks.length + 1,
          title: event.target.querySelector('input').value,
          owner: event.target.querySelector('select').value,
          description: event.target.querySelector('[name="description"]')?.value || '',
          due: 'Сегодня · 15:30', // Simplified for demo
          priority: 'normal', // Default priority
          source: 'Ручная',
          status: window.defaultStatusForNewTask || 'new',
          creator: 'user'
        };
        
        tasks.push(newTask);
        renderKanbanBoard();
        
        button.innerHTML = '<span class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4"></i>Добавлено</span>';
        applyIcons();
        
        // Close modal after a short delay
        setTimeout(() => {
          document.querySelector('[data-close-modal]').click();
          // Reset form
          event.target.reset();
          button.innerHTML = '<span class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4"></i>Сохранить</span>';
          applyIcons();
          window.defaultStatusForNewTask = null;
        }, 1000);
      }, 900);
    });

    applyIcons();
  </script>
  
  <!-- Task Detail Modal (readonly layout like create form) -->
  <div id="task-detail-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/30 px-4">
    <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-6 shadow-lg">
      <div class="flex items-start justify-between">
        <h2 class="text-lg font-semibold text-slate-900">Детали задачи</h2>
        <button type="button" data-close-modal class="rounded-xl border px-3 py-1 text-sm">Закрыть</button>
      </div>
      <div class="mt-4 space-y-4 text-sm">
        <label class="space-y-1 block">
          Название задачи
          <input id="task-detail-title-input" type="text" disabled class="w-full rounded-xl border px-3 py-2 text-sm text-slate-700 bg-slate-50" />
        </label>
        <label class="space-y-1 block">
          Исполнитель
          <select id="task-detail-owner" disabled class="w-full rounded-xl border px-3 py-2 text-sm text-slate-700 bg-slate-50">
            <option>Мария</option>
            <option>Роман</option>
            <option>Анна</option>
          </select>
        </label>
        <label class="space-y-1 block">
          Описание
          <textarea id="task-detail-description-input" disabled class="w-full rounded-xl border px-3 py-2 text-sm text-slate-700 bg-slate-50" rows="4"></textarea>
        </label>
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            Приоритет
            <span id="task-detail-priority" class="badge badge-info">Нормальный</span>
          </div>
          <div class="space-y-1">
            Источник
            <span id="task-detail-source" class="text-slate-700">—</span>
          </div>
          <div class="space-y-1 col-span-2">
            Дедлайн
            <span id="task-detail-due" class="text-slate-700">—</span>
          </div>
        </div>
      </div>
      <div class="mt-6 flex flex-wrap gap-3">
        <button id="task-action-done" class="inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm">
          <i data-lucide="check" class="h-4 w-4"></i>
          Завершить
        </button>
        <button id="task-action-cancel" class="inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm">
          <i data-lucide="ban" class="h-4 w-4"></i>
          Отменить
        </button>
        <button id="task-action-delete" class="inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm text-red-600">
          <i data-lucide="trash-2" class="h-4 w-4"></i>
          Удалить
        </button>
      </div>
    </div>
  </div>
  <nav id="mobile-bottom-nav" class="mobile-bottom-nav"></nav>
</body>
</html>